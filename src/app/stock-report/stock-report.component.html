<div class="stock-report-container">
  <div class="report-header">
    <h2>Stock Report - Locations as Columns</h2>
    <div class="date-range-info">
      <div>Business Day: {{getOpeningStockTime()}} to {{getClosingStockTime()}}</div>
      <div class="date-filter">
        <button (click)="setDateFilter('today')" [class.active]="selectedDateFilter === 'today'">Today</button>
        <button (click)="setDateFilter('yesterday')" [class.active]="selectedDateFilter === 'yesterday'">Yesterday</button>
        <button (click)="setDateFilter('week')" [class.active]="selectedDateFilter === 'week'">This Week</button>
        <button (click)="setDateFilter('all')" [class.active]="selectedDateFilter === 'all'">All Time</button>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading stock report...</p>
  </div>

  <!-- Enhanced Controls with Total Sold Actions -->
  <div class="report-controls">
    <div class="search-box">
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilter()" 
             placeholder="Search products, SKU, category, brand...">
      <button class="search-icon" (click)="applyFilter()">üîç</button>
    </div>
    
    <div class="action-buttons">
      <button class="refresh-total-sold-btn" (click)="refreshTotalSoldData()" [disabled]="isLoading">
        üìä Refresh Total Sold
      </button>
      <button class="export-total-sold-btn" (click)="exportTotalSoldData()">
        üì§ Export Total Sold
      </button>
      <button class="validate-data-btn" (click)="validateTotalSoldData()">
        ‚úÖ Validate Data
      </button>
    </div>
    
    <div class="pagination-controls">
      <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">Previous</button>
      <span>Page {{currentPage}} of {{totalPages}} ({{totalItems}} items)</span>
      <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">Next</button>
    </div>

    <button class="clear-filters-btn" (click)="clearFilters()">Clear Filters</button>
  </div>

  <!-- Stock Report Table -->
  <div class="table-responsive">
    <table class="stock-report-table">
      <thead>
        <tr>
          <!-- Fixed Product Information Columns -->
          <th (click)="sortData('productName')" class="sortable-header">
            Product Name
            <span *ngIf="sortColumn === 'productName'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('sku')" class="sortable-header">
            SKU
            <span *ngIf="sortColumn === 'sku'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('category')" class="sortable-header">
            Category
            <span *ngIf="sortColumn === 'category'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('brand')" class="sortable-header">
            Brand
            <span *ngIf="sortColumn === 'brand'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('unit')" class="sortable-header">
            Unit
            <span *ngIf="sortColumn === 'unit'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('purchasePrice')" class="sortable-header">
            Purchase Price
            <span *ngIf="sortColumn === 'purchasePrice'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('sellingPrice')" class="sortable-header">
            Selling Price
            <span *ngIf="sortColumn === 'sellingPrice'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('margin')" class="sortable-header">
            Margin (%)
            <span *ngIf="sortColumn === 'margin'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          <th (click)="sortData('tax')" class="sortable-header">
            Tax (%)
            <span *ngIf="sortColumn === 'tax'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
          </th>
          
          <!-- Opening and Closing Stock Columns -->
          <th class="opening-stock-column">
            Opening Stock (12:01 AM)
          </th>
          <th class="closing-stock-column">
            Closing Stock (11:59 PM)
          </th>
          
          <!-- Enhanced Total Sold Column -->
        <th (click)="sortData('totalSold')" class="total-sold-column sortable-header">
          Total Sold (All Time)
          <div class="column-info"><small>üìä From all sales data</small></div>
        </th>
          <th (click)="sortData('totalSalesReturned')" class="total-returned-column sortable-header">
          Total Sales Returned
          <div class="column-info"><small>üîÑ From sales returns</small></div>
        </th>
          <!-- NEW: Total Returned Column -->
          <th (click)="sortData('totalReturned')" class="total-returned-column sortable-header">
            Total Returned (All Time)
            <span *ngIf="sortColumn === 'totalReturned'">{{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}}</span>
            <div class="column-info">
              <small>üîÑ From purchase returns</small>
            </div>
          </th>
          
          <th class="last-updated-column">
            Last Updated
          </th>

          <!-- Dynamic Location Columns -->
          <th *ngFor="let location of locations" class="location-column">
            {{location.name}}
            <div class="location-subheaders">
              <span class="subheader">Current</span>
              <span class="subheader">Alert</span>
            </div>
          </th>
          
          <!-- Summary Columns -->
          <th class="summary-column">
            Total Stock
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let item of paginatedData" [class.low-stock-row]="hasLowStockAlert(item)">
          <!-- Fixed Product Information -->
          <td>{{item.productName}}</td>
          <td>{{item.sku}}</td>
          <td>{{item.category || '-'}}</td>
          <td>{{item.brand || '-'}}</td>
          <td>{{item.unit}}</td>
          <td>{{item.purchasePrice | currency:'INR':'symbol'}}</td>
          <td>{{item.sellingPrice | currency:'INR':'symbol'}}</td>
          <td>{{item.margin}}%</td>
          <td>{{item.tax}}%</td>
          
          <!-- Opening and Closing Stock Data -->
          <td class="opening-stock-data">
            {{item.openingStock}}
          </td>
          <td class="closing-stock-data">
            {{item.closingStock}}
          </td>
          
         <td class="total-sold-data">
          <div class="total-sold-value">{{item.totalSold}}</div>
          <div *ngIf="item.totalSold === 0"><small class="no-sales-badge">üì¶ No sales</small></div>
        </td>
        
        <!-- *** MODIFIED: This cell now displays the new totalSalesReturned property *** -->
        <td class="total-returned-data">
          <div class="total-returned-value">{{item.totalSalesReturned}}</div>
          <div *ngIf="item.totalSalesReturned > 0"><small class="returned-badge">üîÑ {{item.totalSalesReturned}} returned</small></div>
          <div *ngIf="item.totalSalesReturned === 0"><small class="no-returns-badge">üì¶ No returns</small></div>
        </td>
        
          
          <!-- NEW: Enhanced Total Returned Data -->
          <td class="total-returned-data enhanced-total-returned">
            <div class="total-returned-value">
              {{item.totalReturned}}
            </div>
            <div class="total-returned-indicator" *ngIf="item.totalReturned > 0">
              <small class="returned-badge">üîÑ {{item.totalReturned}} returned</small>
            </div>
            <div class="no-returns-indicator" *ngIf="item.totalReturned === 0">
              <small class="no-returns-badge">üì¶ No returns</small>
            </div>
          </td>
          
          <td class="last-updated-data">
            {{item.lastUpdated | date:'short'}}
          </td>

          <!-- Dynamic Location Stock Data -->
          <td *ngFor="let location of locations" class="location-data">
            <ng-container *ngIf="getStockForLocation(item, location.id) as stock; else noStock">
              <div class="stock-info">
                <div class="current-stock" [class.alert]="stock.currentStock <= item.alertQuantity">
                  {{stock.currentStock}}
                  <span *ngIf="stock.currentStock <= item.alertQuantity" class="alert-icon">‚ö†</span>
                </div>
                <div class="alert-level">Alert: {{item.alertQuantity}}</div>
              </div>
            </ng-container>
            <ng-template #noStock>
              <div class="no-stock">-</div>
            </ng-template>
          </td>
          
          <!-- Summary Data -->
          <td class="total-stock-data">
            {{getTotalStock(item)}}
          </td>
        </tr>

        <tr *ngIf="filteredData.length === 0 && !isLoading">
          <td [attr.colspan]="14 + locations.length" class="no-data">
            No products found. Try adjusting your search criteria.
          </td>
        </tr>
      </tbody>

      <!-- Summary Footer with Total Sold and Returned Information -->
      <tfoot>
        <tr class="summary-row">
          <td colspan="11" class="summary-label">Summary:</td>
          <td class="total-sold-summary">
            <div class="summary-total-sold">
              Total Sold: {{getTotalSold()}}
            </div>
          </td>
          <td class="total-returned-summary">
            <div class="summary-total-returned">
              Total Returned: {{getTotalReturned()}}
            </div>
          </td>
          <td></td> <!-- Last Updated column -->
          <td *ngFor="let location of locations" class="location-summary">
            <div class="location-total">
              Total: {{getTotalStockForLocation(location.id)}}
            </div>
          </td>
          <td class="grand-total">
            {{getGrandTotalStock()}}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Enhanced Stock Alerts Summary -->
  <div class="alerts-summary" *ngIf="getLowStockProducts().length > 0">
    <h3>‚ö† Low Stock Alerts ({{getLowStockProducts().length}} products)</h3>
    <div class="alert-items">
      <div *ngFor="let item of getLowStockProducts()" class="alert-item">
        <span class="product-name">{{item.productName}} ({{item.sku}})</span>
        <span class="total-sold-info">Total Sold: {{item.totalSold}}</span>
        <span class="total-returned-info">Total Returned: {{item.totalReturned}}</span>
        <span class="locations-affected">
          Locations: {{getLocationsWithLowStock(item).join(', ')}}
        </span>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="report-generated">
      Report generated on: {{getCurrentDate()}}
    </div>
    <div class="summary-stats">
      <div class="total-sold-info">
        Total products with sales: {{getProductsWithSalesCount()}} / {{filteredData.length || 0}}
      </div>
      <div class="total-returned-info">
        Total products with returns: {{getProductsWithReturnsCount()}} / {{filteredData.length || 0}}
      </div>
    </div>
    <div class="copyright">
      HYBRID CRM - v6.2 | Copyright ¬© {{currentYear}} All rights reserved.
    </div>
  </div>
</div>