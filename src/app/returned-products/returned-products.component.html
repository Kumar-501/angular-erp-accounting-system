<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h4>Returned Products</h4>
      <p class="mb-0 text-muted">List of all returned products with their details</p>
    </div>
    
    <div class="card-body">
      <!-- Search and Filter Section -->
      <div class="row mb-4">
        <!-- Show entries and Search -->
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <label class="me-2">Show</label>
            <select class="form-select form-select-sm me-2" [(ngModel)]="pageSize" (change)="onPageSizeChange()" style="width: auto;">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          
          <div class="input-group">
            <input type="text" class="form-control" 
                   [(ngModel)]="searchTerm"
                   (input)="onSearchInput()"
                   placeholder="Search by product ID, name, SKU, return ID...">
            <button class="btn btn-outline-secondary" 
                    type="button" 
                    (click)="searchReturns()"
                    [disabled]="isLoading">
              <i class="fa fa-search"></i> Search
            </button>
            <button class="btn btn-outline-secondary" 
                    type="button" 
                    (click)="clearSearch()"
                    [disabled]="isLoading"
                    *ngIf="searchTerm">
              <i class="fa fa-times"></i> Clear
            </button>
          </div>
        </div>
        
        <!-- Date Range Filter -->
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <label class="me-2">Date Filter:</label>
            <button class="btn btn-sm btn-outline-secondary" 
                    (click)="clearDateFilter()"
                    *ngIf="dateRange.start || dateRange.end">
              <i class="fa fa-times"></i> Clear Dates
            </button>
          </div>
          
          <div class="input-group">
            <input type="date" class="form-control" 
                   [(ngModel)]="dateRange.start"
                   (change)="applyFilter()"
                   placeholder="From date">
            <span class="input-group-text">to</span>
            <input type="date" class="form-control" 
                   [(ngModel)]="dateRange.end"
                   (change)="applyFilter()"
                   placeholder="To date">
            <button class="btn btn-outline-secondary" 
                    type="button" 
                    (click)="searchReturns()"
                    [disabled]="isLoading">
              <i class="fa fa-filter"></i> Filter
            </button>
          </div>
        </div>
      </div>

      <!-- Export Button -->
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-success btn-sm" 
                (click)="exportToCSV()"
                [disabled]="isLoading || filteredProducts.length === 0">
          <i class="fa fa-download"></i> Export CSV
        </button>
      </div>
      
      <!-- Loading Indicator -->
      <div *ngIf="isLoading" class="text-center my-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading returned products...</p>
      </div>
      
      <!-- No Results Message -->
      <div *ngIf="!isLoading && paginatedProducts.length === 0" class="alert alert-info">
        <i class="fa fa-info-circle"></i> 
        <span *ngIf="searchTerm || dateRange.start || dateRange.end">
          No returned products found matching your search criteria.
        </span>
        <span *ngIf="!searchTerm && !dateRange.start && !dateRange.end">
          No returned products found.
        </span>
      </div>
      
      <!-- Returned Products Table -->
      <div *ngIf="!isLoading && paginatedProducts.length > 0" class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Return Details</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Subtotal</th>
              <th>Return Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let product of paginatedProducts">
              <td>
                <strong>{{ product.productName }}</strong>
                <div class="text-muted small">
                  ID: {{ product.productId }}<br>
                  <span *ngIf="product.sku">SKU: {{ product.sku }}<br></span>
                  <span *ngIf="product.reason">Reason: {{ product.reason }}</span>
                </div>
              </td>
              <td>
                <div class="small">
                  Return ID: {{ product.returnId }}<br>
                  Sale ID: {{ product.originalSaleId }}
                </div>
              </td>
              <td>
                <span class="badge bg-danger">
                  {{ product.returnQuantity || product.quantity }} returned
                </span>
                <div *ngIf="product.originalQuantity" class="small text-muted">
                  (of {{ product.originalQuantity }})
                </div>
              </td>
              <td>₹{{ product.unitPrice | number:'1.2-2' }}</td>
              <td>₹{{ product.subtotal | number:'1.2-2' }}</td>
              <td>{{ formatDate(product.returnDate) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination Section -->
      <div class="pagination-section d-flex justify-content-between align-items-center mt-3" *ngIf="!isLoading && filteredProducts.length > 0">
        <div class="showing-entries">
          Showing {{ startRecord }} to {{ endRecord }} of {{ totalRecords }} entries
          <span *ngIf="searchTerm || dateRange.start || dateRange.end" class="text-muted">
            (filtered from {{ returnedProducts.length }} total entries)
          </span>
        </div>
        
        <nav aria-label="Page navigation" *ngIf="totalPages > 1">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
                <i class="fa fa-chevron-left"></i>
              </button>
            </li>
            
            <li class="page-item" *ngFor="let page of getVisiblePages()" [class.active]="page === currentPage">
              <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
            </li>
            
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
                <i class="fa fa-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
      
      <!-- Summary Information -->
      <div *ngIf="!isLoading && filteredProducts.length > 0" class="alert alert-secondary mt-3">
        <div class="row">
          <div class="col-md-4">
            <strong>Total Returns:</strong> {{ filteredProducts.length }}
          </div>
          <div class="col-md-4">
            <strong>Total Quantity Returned:</strong> 
            {{ totalQuantityReturned }}
          </div>
          <div class="col-md-4">
            <strong>Total Refund Amount:</strong> 
            ₹{{ totalRefundAmount | number:'1.2-2' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>