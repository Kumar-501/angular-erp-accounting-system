<!-- src/app/income-receipts/income-receipts.component.html -->
<div class="container">
  <header class="page-header">
    <h1>Receipts</h1>
    <button class="btn btn-primary new-receipt-btn" (click)="openModal()">+ New Receipt</button>
  </header>

  <div class="summary-cards">
      <div class="card">Total Receipts<span>{{ totalReceiptsAmount | currency:'INR' }}</span></div>
      <div class="card">This Month<span>{{ thisMonthCount }}</span></div>
      <div class="card">Pending<span>{{ pendingCount }}</span></div>
  </div>

  <div class="table-container">
    <h2>Receipt Transactions ({{ receipts.length }})</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Reference</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let receipt of receipts">
          <td>{{ receipt.date.toDate() | date:'yyyy-MM-dd' }}</td>
          <td>{{ receipt.referenceNo }}</td>
          <td>{{ receipt.totalAmount | currency:'INR' }}</td>
          <td><span class="status" [ngClass]="receipt.status.toLowerCase()">{{ receipt.status }}</span></td>
          <td class="actions">
            <button class="btn-icon" (click)="openViewModal(receipt)" title="View Details">üëÅÔ∏è</button>
            <button class="btn-icon" (click)="openModal(receipt)" title="Edit Receipt">‚úèÔ∏è</button>
            <button *ngIf="receipt.attachment" class="btn-icon" (click)="downloadAttachment(receipt)" title="Download Attachment">üíæ</button>
            <button class="btn-icon" (click)="deleteReceipt(receipt.id)" title="Delete Receipt">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- New/Edit Receipt Modal -->
<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-content large">
    <header class="modal-header">
      <h2>{{ isEditMode ? 'Edit' : 'New' }} Receipt Entry</h2>
      <button class="close-button" (click)="closeModal()">&times;</button>
    </header>

    <form [formGroup]="receiptForm" (ngSubmit)="saveReceipt()">
      <fieldset class="transaction-details">
        <legend>Transaction Details</legend>
        <div class="form-row">
          <div class="form-group">
            <label for="date">Date*</label>
            <input type="date" id="date" formControlName="date" required>
          </div>
          <div class="form-group">
            <label for="referenceNo">Reference</label>
            <input type="text" id="referenceNo" formControlName="referenceNo">
          </div>
          <div class="form-group">
            <label for="status">Status*</label>
            <select id="status" formControlName="status" required>
                <option value="Posted">Posted</option>
                <option value="Pending">Pending</option>
            </select>
          </div>
          <div class="form-group description-group">
            <label for="description">Description*</label>
            <input type="text" id="description" formControlName="description" required placeholder="Transaction description">
          </div>
        </div>
        <div class="form-row" formGroupName="attachment">
            <div class="form-group">
              <label for="attachment-file">Attachment</label>
              <input type="file" id="attachment-file" (change)="onFileSelect($event)">
              <span *ngIf="receiptForm.get('attachment.name')?.value" class="file-name">
                Selected: {{ receiptForm.get('attachment.name')?.value }}
              </span>
            </div>
        </div>
      </fieldset>

      <fieldset>
        <div class="journal-header">
          <legend>Journal Entries</legend>
          <button type="button" class="btn-add-entry" (click)="addItem()">+ Add Entry</button>
        </div>
        <div class="journal-items-table">
          <table>
            <thead>
              <tr><th>Account*</th><th>Credit</th><th>Debit</th><th>Actions</th></tr>
            </thead>
            <tbody formArrayName="items">
              <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                <td>
                  <!-- UPDATED: Select options now display accountHead -->
                  <select formControlName="accountId" (change)="onAccountSelect(i)" required>
                    <option value="" disabled>Select an item...</option>
                    <optgroup label="Accounts"><option *ngFor="let acc of accounts" [value]="acc.id">{{ acc.name }}</option></optgroup>
                    <optgroup label="Income Categories"><option *ngFor="let cat of incomeCategories" [value]="cat.id">{{ cat.categoryName }} {{ cat.accountHead ? '(' + cat.accountHead + ')' : '' }}</option></optgroup>
                    <optgroup label="Expense Categories"><option *ngFor="let cat of expenseCategories" [value]="cat.id">{{ cat.categoryName }} {{ cat.accountHead ? '(' + cat.accountHead + ')' : '' }}</option></optgroup>
                    <optgroup label="Tax Rates"><option *ngFor="let tax of taxRates" [value]="tax.id">{{ tax.name }} ({{ tax.rate }}%)</option></optgroup>
                  </select>
                </td>
                <td><input type="number" formControlName="debit" min="0"></td>
                <td><input type="number" formControlName="credit" min="0"></td>
                <td><button type="button" class="btn-icon" (click)="removeItem(i)" title="Remove Entry">üóëÔ∏è</button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </fieldset>
      
      <div class="totals-section">
          <div>Total Credits: <span>{{ totalDebits | currency:'INR' }}</span></div>
          <div>Total Debits: <span>{{ totalCredits | currency:'INR' }}</span></div>
          <div class="difference" [class.unbalanced]="difference !== 0">
              Difference: <span>{{ difference | currency:'INR' }}</span>
          </div>
      </div>

      <footer class="modal-footer">
        <button type="submit" class="btn btn-primary" [disabled]="receiptForm.invalid || difference !== 0 || isSaving">
          {{ isSaving ? 'Saving...' : 'Save Receipt' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      </footer>
    </form>
  </div>
</div>

<!-- View Receipt Details Modal (READ-ONLY) -->
<div class="modal-overlay" *ngIf="showViewModal">
  <div class="modal-content large" *ngIf="selectedReceiptForView">
      <header class="modal-header">
          <h2>Receipt Details</h2>
          <button class="close-button" (click)="closeModal()">&times;</button>
      </header>
      <div class="view-details-body">
          <fieldset class="transaction-details">
              <legend>Transaction Details</legend>
              <div class="details-grid">
                  <div><strong>Date:</strong> {{ selectedReceiptForView.date.toDate() | date:'longDate' }}</div>
                  <div><strong>Reference:</strong> {{ selectedReceiptForView.referenceNo }}</div>
                  <div><strong>Status:</strong> <span class="status" [ngClass]="selectedReceiptForView.status.toLowerCase()">{{ selectedReceiptForView.status }}</span></div>
                  <div class="description-view"><strong>Description:</strong> {{ selectedReceiptForView.description }}</div>
              </div>
          </fieldset>
          <fieldset>
              <legend>Journal Entries</legend>
              <div class="journal-items-table">
                  <table>
                      <thead>
                          <tr><th>Account</th><th class="text-right">Debit</th><th class="text-right">Credit</th></tr>
                      </thead>
                      <tbody>
                          <!-- UPDATED: Now displays accountHead in view mode -->
                          <tr *ngFor="let item of selectedReceiptForView.items">
                              <td>{{ item.accountName }} {{ item.accountHead ? '(' + item.accountHead + ')' : '' }}</td>
                              <td class="text-right">{{ item.debit | currency:'INR' }}</td>
                              <td class="text-right">{{ item.credit | currency:'INR' }}</td>
                          </tr>
                      </tbody>
                      <tfoot>
                          <tr>
                              <td class="text-right"><strong>Totals:</strong></td>
                              <td class="text-right"><strong>{{ selectedReceiptForView.totalAmount | currency:'INR' }}</strong></td>
                              <td class="text-right"><strong>{{ selectedReceiptForView.totalAmount | currency:'INR' }}</strong></td>
                          </tr>
                      </tfoot>
                  </table>
              </div>
          </fieldset>
      </div>
      <footer class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
      </footer>
  </div>
</div>