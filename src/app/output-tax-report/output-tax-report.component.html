<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12"><h3>Output Tax Report</h3></div>
  </div>

  <!-- Filters -->
  <div class="filter-card mb-4">
    <div class="card">
      <div class="card-body">
        <div class="row align-items-end g-3">
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Date Range</label>
            <select class="form-select" [(ngModel)]="filterOptions.quickDateFilter" (change)="setQuickDateFilter($any($event.target).value)">
                <option value="today">Today</option>
                <option value="thisMonth">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
          </div>
          
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Tax Filter</label>
            <select class="form-select" [(ngModel)]="taxRateFilter" (change)="setupFilter()">
              <option value="">All Rates</option>
              <option *ngFor="let r of taxRates" [value]="r.rate">{{ r.name }} ({{ r.rate }}%)</option>
            </select>
          </div>

<div class="col-lg-3 col-md-6" *ngIf="filterOptions.quickDateFilter === 'custom'">
  <label class="form-label">Start</label>
  <div class="date-input-wrapper">
    <input type="text" 
           class="form-control date-input" 
           [value]="getFormattedDateForInput(filterOptions.dateRange.startDate)"
           (blur)="onManualDateInput($event, 'start')"
           placeholder="DD-MM-YYYY">
    <button type="button" class="calendar-btn" (click)="openDatePicker('start')">
      <i class="fa fa-calendar-alt"></i>
    </button>
    <input #startDatePicker type="date" class="hidden-date-picker" [(ngModel)]="filterOptions.dateRange.startDate" (change)="setupFilter()">
  </div>
</div>

<div class="col-lg-3 col-md-6" *ngIf="filterOptions.quickDateFilter === 'custom'">
  <label class="form-label">End</label>
  <div class="date-input-wrapper">
    <input type="text" 
           class="form-control date-input" 
           [value]="getFormattedDateForInput(filterOptions.dateRange.endDate)"
           (blur)="onManualDateInput($event, 'end')"
           placeholder="DD-MM-YYYY">
    <button type="button" class="calendar-btn" (click)="openDatePicker('end')">
      <i class="fa fa-calendar-alt"></i>
    </button>
    <input #endDatePicker type="date" class="hidden-date-picker" [(ngModel)]="filterOptions.dateRange.endDate" (change)="setupFilter()">
  </div>
</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards mb-4">
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-primary"><div class="card-body"><h5>Total CGST</h5><p class="h4">₹{{ getTotalCGST((filteredSales$ | async) || []) | number:'1.2-2' }}</p></div></div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-success"><div class="card-body"><h5>Total SGST</h5><p class="h4">₹{{ getTotalSGST((filteredSales$ | async) || []) | number:'1.2-2' }}</p></div></div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-warning text-dark"><div class="card-body"><h5>Total IGST</h5><p class="h4">₹{{ getTotalIGST((filteredSales$ | async) || []) | number:'1.2-2' }}</p></div></div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-dark"><div class="card-body"><h5>Net Tax Liability</h5><p class="h4">₹{{ getTotalTax((filteredSales$ | async) || []) | number:'1.2-2' }}</p></div></div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="report-card">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
          <div class="action-buttons d-flex gap-2">
            <button class="btn btn-outline-primary" (click)="exportToExcel()"><i class="fa fa-file-excel"></i> Export</button>
            <button class="btn btn-success" (click)="saveReport()" [disabled]="isSaving"><i class="fa fa-save"></i> Save Report</button>
          </div>
          <div class="d-flex align-items-center">
            <span>Show</span>
            <select class="form-select mx-2" style="width: auto;" [(ngModel)]="pageSize">
              <option [ngValue]="10">10</option><option [ngValue]="50">50</option><option [ngValue]="-1">All</option>
            </select>
            <span>entries</span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th *ngIf="columnVisibility.date" (click)="sortData('saleDate')">Date</th>
                <th *ngIf="columnVisibility.type">Type</th>
                <th *ngIf="columnVisibility.invoiceNo">Ref/Invoice</th>
                <th *ngIf="columnVisibility.customer">Customer</th>
                <!-- Taxable Amount Header Hidden -->
                <th *ngIf="columnVisibility.cgst" class="text-end">CGST</th>
                <th *ngIf="columnVisibility.sgst" class="text-end">SGST</th>
                <th *ngIf="columnVisibility.igst" class="text-end">IGST</th>
                <th *ngIf="columnVisibility.totalTax" class="text-end">Total Tax</th>
                <th *ngIf="columnVisibility.taxPercentage" class="text-end">Tax %</th>
                <th *ngIf="columnVisibility.totalAmount" class="text-end">Total Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of (filteredSales$ | async)?.slice((currentPage-1)*pageSize, pageSize===-1?9999:currentPage*pageSize); trackBy: trackBySaleId">
<!-- Inside <tbody> -> <tr> -->
<td *ngIf="columnVisibility.date">{{ entry.saleDate | date:'dd-MM-yyyy' }}</td>                <td *ngIf="columnVisibility.type">
                  <span class="badge" [ngClass]="{'bg-success': entry.entryType === 'Sale', 'bg-info': entry.entryType === 'Income', 'bg-danger': entry.entryType === 'Return'}">
                    {{ entry.entryType }}
                  </span>
                </td>
                <td *ngIf="columnVisibility.invoiceNo">{{ entry.invoiceNo }}</td>
                <td *ngIf="columnVisibility.customer">{{ entry.customer }}</td>
                <!-- Taxable Amount Data Cell Hidden -->
                <td *ngIf="columnVisibility.cgst" class="text-end">{{ entry.taxDetails.cgst | currency:'INR' }}</td>
                <td *ngIf="columnVisibility.sgst" class="text-end">{{ entry.taxDetails.sgst | currency:'INR' }}</td>
                <td *ngIf="columnVisibility.igst" class="text-end">{{ entry.taxDetails.igst | currency:'INR' }}</td>
                <td *ngIf="columnVisibility.totalTax" class="text-end" [class.text-danger]="entry.taxAmount < 0">{{ entry.taxAmount | currency:'INR' }}</td>
                <td *ngIf="columnVisibility.taxPercentage" class="text-end">{{ getEntryTaxDisplay(entry) }}</td>
                <td *ngIf="columnVisibility.totalAmount" class="text-end" [class.text-danger]="entry.totalPayable < 0">{{ entry.totalPayable | currency:'INR' }}</td>
              </tr>
            </tbody>
            <tfoot class="table-light" *ngIf="(filteredSales$ | async)?.length">
              <tr>
                <th colspan="4" class="text-end">Total:</th>
                <!-- Taxable Amount Total Footer Cell Hidden -->
                <th class="text-end">{{ getTotalCGST((filteredSales$ | async)!) | currency:'INR' }}</th>
                <th class="text-end">{{ getTotalSGST((filteredSales$ | async)!) | currency:'INR' }}</th>
                <th class="text-end">{{ getTotalIGST((filteredSales$ | async)!) | currency:'INR' }}</th>
                <th class="text-end">{{ getTotalTax((filteredSales$ | async)!) | currency:'INR' }}</th>
                <th></th>
                <th class="text-end">{{ getTotalAmount((filteredSales$ | async)!) | currency:'INR' }}</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>