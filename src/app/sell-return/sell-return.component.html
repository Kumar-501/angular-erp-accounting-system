<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4>Process Return - Invoice #{{ saleData?.invoiceNo }}</h4>
      <button class="btn btn-secondary btn-sm" (click)="navigateToSales()" [disabled]="isProcessing">
        <i class="fa fa-arrow-left"></i> Back to Sales
      </button>
    </div>
    
    <div class="card-body">
      <!-- Sale Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h5>Customer: {{ saleData?.customer }}</h5>
          <p><strong>Original Sale Date:</strong> {{ saleData?.saleDate | date:'mediumDate' }}</p>
          <p><strong>Sale ID:</strong> {{ saleData?.id }}</p>
        </div>
        <div class="col-md-6 text-end">
          <div class="alert alert-info">
            <h5 class="mb-1">Total Refund Amount: ₹{{ totalRefundAmount | number:'1.2-2' }}</h5>
            <small class="text-muted">Amount will be refunded to customer</small>
          </div>
        </div>
      </div>
      
      <!-- Return Items Table -->
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Original Qty</th>
              <th>Return Qty</th>
              <th>Unit Price (₹)</th>
              <th>Subtotal (₹)</th>
              <th class="text-center">Return Item</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of returnedItems; let i = index" 
                [class.table-warning]="item.isReturning">
              <td>
                <strong>{{ item.name }}</strong>
                <br>
                <small class="text-muted">
                  ID: {{ item.productId || item.id || 'N/A' }}
                  <span *ngIf="item.sku"> | SKU: {{ item.sku }}</span>
                </small>
              </td>
              <td>
                <span class="badge bg-primary">{{ item.originalQuantity }}</span>
              </td>
              <td>
                <div class="input-group input-group-sm" style="max-width: 150px;">
                  <button class="btn btn-outline-secondary" type="button" 
                          (click)="decreaseReturnQuantity(i)"
                          [disabled]="!item.isReturning || item.returnQuantity <= 0">
                    <i class="fa fa-minus"></i>
                  </button>
                  <input type="number" class="form-control text-center" 
                         [(ngModel)]="item.returnQuantity" 
                         [disabled]="!item.isReturning"
                         (change)="validateReturnQuantity(i)"
                         min="0" [max]="item.originalQuantity">
                  <button class="btn btn-outline-secondary" type="button" 
                          (click)="increaseReturnQuantity(i)"
                          [disabled]="!item.isReturning || item.returnQuantity >= item.originalQuantity">
                    <i class="fa fa-plus"></i>
                  </button>
                </div>
              </td>
              <td>₹{{ item.unitPrice | number:'1.2-2' }}</td>
              <td>
                <strong>₹{{ (item.isReturning ? (item.unitPrice * item.returnQuantity) : 0) | number:'1.2-2' }}</strong>
              </td>
              <td class="text-center">
                <div class="form-check form-switch d-flex justify-content-center">
                  <input class="form-check-input" type="checkbox" 
                         [(ngModel)]="item.isReturning"
                         (change)="toggleItemReturn(i)"
                         [id]="'returnSwitch' + i">
                  <label class="form-check-label ms-2" [for]="'returnSwitch' + i">
                    <span class="badge" 
                          [ngClass]="item.isReturning ? 'bg-success' : 'bg-secondary'">
                      {{ item.isReturning ? 'Returning' : 'Keep' }}
                    </span>
                  </label>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="table-info">
              <td colspan="4" class="text-end"><strong>Total Refund:</strong></td>
              <td><strong>₹{{ totalRefundAmount | number:'1.2-2' }}</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <!-- Return Reason and Process Button -->
      <div class="row mt-4">
        <div class="col-md-8">
          <label for="returnReason" class="form-label">
            <strong>Return Reason *</strong>
          </label>
          <textarea class="form-control" id="returnReason" rows="3" 
                    [(ngModel)]="returnReason" 
                    [disabled]="isProcessing"
                    placeholder="Please enter the reason for return (required)"
                    maxlength="500"></textarea>
          <small class="form-text text-muted">{{ returnReason.length }}/500 characters</small>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-primary btn-lg w-100" 
                  (click)="processReturn()"
                  [disabled]="isProcessing || !returnReason.trim() || totalRefundAmount <= 0">
            <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-2"></span>
            <i class="fa fa-check me-2" *ngIf="!isProcessing"></i>
            {{ isProcessing ? 'Processing...' : 'Process Return' }}
          </button>
        </div>
      </div>
      
      <!-- Instructions -->
      <div class="alert alert-info mt-3">
        <h6><i class="fa fa-info-circle"></i> Instructions:</h6>
        <ul class="mb-0">
          <li>Select the items you want to return by toggling the "Return Item" switch</li>
          <li>Adjust the return quantity using the +/- buttons or by typing in the field</li>
          <li>Provide a clear reason for the return</li>
          <li>The stock will be automatically restored to inventory upon processing</li>
          <li>The original sale record will be updated to reflect the returned items</li>
        </ul>
      </div>
    </div>
  </div>
</div>