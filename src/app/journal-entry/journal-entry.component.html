<div class="container">
  <header class="page-header">
    <h1>Journal Entries</h1>
    <button class="btn btn-primary" (click)="openModal()">+ New Journal</button>
  </header>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Reference</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let journal of journals">
          <td>{{ journal.date.toDate() | date:'shortDate' }}</td>
          <td>{{ journal.reference }}</td>
          <td>{{ journal.description }}</td>
          <td>{{ journal.totalAmount | currency:'INR' }}</td>
          <td class="actions">
            <button class="btn-icon" (click)="openViewModal(journal)" title="View Details">üëÅÔ∏è</button>
            <button class="btn-icon" (click)="openModal(journal)" title="Edit Journal">‚úèÔ∏è</button>
            <button *ngIf="journal.attachment" class="btn-icon" (click)="downloadAttachment(journal)" title="Download Attachment">üíæ</button>
            <button class="btn-icon" (click)="deleteJournal(journal.id)" title="Delete Journal">üóëÔ∏è</button>
          </td>
        </tr>
        <tr *ngIf="journals.length === 0">
          <td colspan="5">No journal entries found.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- New/Edit Journal Entry Modal (FORM) -->
<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-content large">
    <header class="modal-header">
      <h2>{{ isEditMode ? 'Edit' : 'New' }} Journal Entry</h2>
      <button class="close-button" (click)="closeModal()">&times;</button>
    </header>

    <form [formGroup]="journalForm" (ngSubmit)="saveJournal()">
      <!-- Transaction Details -->
      <fieldset class="transaction-details">
        <legend>Transaction Details</legend>
        <div class="form-row">
<!-- Inside the Transaction Details fieldset -->
<div class="form-group">
  <label for="date">Date*</label>
  <div class="date-input-wrapper">
    <!-- Visible Text Input for DD-MM-YYYY -->
    <input type="text" 
           id="dateDisplay"
           class="form-control date-input" 
           [value]="getFormattedDateForInput(journalForm.get('date')?.value)"
           (blur)="onManualDateInput($event, 'date')"
           placeholder="DD-MM-YYYY">
    
    <!-- Calendar Button -->
    <button type="button" class="calendar-btn" (click)="openDatePicker()">
      <i class="fa fa-calendar-alt"></i>
    </button>
    
    <!-- Hidden Native Picker -->
    <input #datePicker 
           type="date" 
           id="date"
           formControlName="date" 
           class="hidden-date-picker">
  </div>
  <div *ngIf="journalForm.get('date')?.invalid && journalForm.get('date')?.touched" class="error-text">
    Date is required
  </div>
</div>
          <div class="form-group">
            <label for="reference">Reference</label>
            <input type="text" id="reference" formControlName="reference">
          </div>
          <div class="form-group description-group">
            <label for="description">Description*</label>
            <input type="text" id="description" formControlName="description" required>
          </div>
        </div>
        <div class="form-row" formGroupName="attachment">
          <div class="form-group">
            <label for="attachment-file">Attachment</label>
            <input type="file" id="attachment-file" (change)="onFileSelect($event)">
            <span *ngIf="journalForm.get('attachment.name')?.value" class="file-name">
              Selected: {{ journalForm.get('attachment.name')?.value }}
            </span>
          </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="isCapitalTransaction" formControlName="isCapitalTransaction">
                    <label for="isCapitalTransaction">Capital Transaction</label>
                </div>
            </div>
        </div>
      </fieldset>

      <!-- Journal Entries -->
      <fieldset>
        <legend>Journal Entries</legend>
        <div class="journal-items-table">
          <table>
            <thead>
              <tr>
                <th>Account*</th>
               
                 <th>Debit</th>
                                 <th>Credit</th>

                <th>Actions</th>
              </tr>
            </thead>
            <tbody formArrayName="items">
              <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                <td>
                  <select formControlName="accountId" (change)="onAccountSelect(i)" required>
                    <option value="" disabled>Select an item...</option>
                    <optgroup label="Accounts"><option *ngFor="let acc of accounts" [value]="acc.id">{{ acc.name }}</option></optgroup>
                    <optgroup label="Income Categories"><option *ngFor="let cat of incomeCategories" [value]="cat.id">{{ cat.categoryName }} {{ cat.accountHead ? '(' + cat.accountHead + ')' : '' }}</option></optgroup>
                    <optgroup label="Expense Categories"><option *ngFor="let cat of expenseCategories" [value]="cat.id">{{ cat.categoryName }} {{ cat.accountHead ? '(' + cat.accountHead + ')' : '' }}</option></optgroup>
                    <optgroup label="Tax Rates"><option *ngFor="let tax of taxRates" [value]="tax.id">{{ tax.name }} ({{ tax.rate }}%)</option></optgroup>
                  </select>
                </td>
                <td><input type="number" formControlName="credit" min="0"></td>
                                <td><input type="number" formControlName="debit" min="0"></td>

                <td>
                  <button type="button" class="btn-icon" (click)="removeItem(i)" title="Remove Entry">üóëÔ∏è</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button type="button" class="btn-add-entry" (click)="addItem()">+ Add Entry</button>
      </fieldset>
      
      <!-- Totals -->
      <div class="totals-section">
                  <div>Total Debit: <span>{{ totalCredits | currency:'INR' }}</span></div>

          <div>Total Credit: <span>{{ totalDebits | currency:'INR' }}</span></div>
          <!-- FIXED: Show difference but allow capital transactions to be unbalanced -->
          <div class="difference" [class.unbalanced]="difference !== 0 && !journalForm.get('isCapitalTransaction')?.value">
              Difference: <span>{{ difference | currency:'INR' }}</span>
              <span *ngIf="journalForm.get('isCapitalTransaction')?.value && difference !== 0" class="capital-note">
                (Capital transactions can be unbalanced)
              </span>
          </div>
      </div>

      <footer class="modal-footer">
        <!-- FIXED: Use the new isBalanced getter -->
        <button type="submit" class="btn btn-primary" [disabled]="journalForm.invalid || !isBalanced || isSaving">
          {{ isSaving ? 'Saving...' : 'Save Journal' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      </footer>
    </form>
  </div>
</div>

<!-- View Journal Details Modal -->
<div class="modal-overlay" *ngIf="showViewModal">
  <div class="modal-content large" *ngIf="selectedJournalForView">
      <header class="modal-header">
          <h2>Journal Details</h2>
          <button class="close-button" (click)="closeModal()">&times;</button>
      </header>
      <div class="view-details-body">
          <fieldset class="transaction-details">
              <legend>Transaction Details</legend>
              <div class="details-grid">
                  <div><strong>Date:</strong> {{ selectedJournalForView.date.toDate() | date:'longDate' }}</div>
                  <div><strong>Reference:</strong> {{ selectedJournalForView.reference }}</div>
                  <div class="description-view"><strong>Description:</strong> {{ selectedJournalForView.description }}</div>
                  <div *ngIf="selectedJournalForView?.isCapitalTransaction"><strong>Type:</strong> Capital Transaction</div>
              </div>
          </fieldset>
          <fieldset>
              <legend>Journal Entries</legend>
              <div class="journal-items-table">
                  <table>
                      <thead>
                          <tr>
                              <th>Account</th>
                              <th class="text-right">Debit</th>
                                                            <th class="text-right">Credit</th>

                          </tr>
                      </thead>
                      <tbody>
                          <tr *ngFor="let item of selectedJournalForView.items">
                              <td>{{ item.accountName }} {{ item.accountHead ? '(' + item.accountHead + ')' : '' }}</td>
                              <td class="text-right">{{ item.credit | currency:'INR' }}</td>
                                                            <td class="text-right">{{ item.debit | currency:'INR' }}</td>

                          </tr>
                      </tbody>
                      <tfoot>
                          <tr>
                              <td class="text-right"><strong>Totals:</strong></td>
                              <!-- FIXED: Calculate totals properly for display -->
                  <td class="text-right">
  <strong>{{ getTotalDebit(selectedJournalForView.items) | currency:'INR' }}</strong>
</td>
<td class="text-right">
  <strong>{{ getTotalCredit(selectedJournalForView.items) | currency:'INR' }}</strong>
</td>
                          </tr>
                      </tfoot>
                  </table>
              </div>
          </fieldset>
      </div>
      <footer class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
      </footer>
  </div>
</div>