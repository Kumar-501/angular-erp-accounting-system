<!-- Sale Details View Modal -->
<div class="modal fade" id="viewSaleModal" tabindex="-1" aria-labelledby="viewSaleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewSaleModalLabel">Sale Details - Invoice #{{ selectedSale?.invoiceNo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6>Customer Information</h6>
            <p><strong>Name:</strong> {{ selectedSale?.customer }}</p>
            <p><strong>Contact:</strong> {{ selectedSale?.customerPhone }}</p>
            <p><strong>Email:</strong> {{ selectedSale?.customerEmail || 'N/A' }}</p>
            <p><strong>Address:</strong> {{ selectedSale?.billingAddress || selectedSale?.shippingAddress || 'N/A' }}</p>
          </div>
          <div class="col-md-6">
            <h6>Order Information</h6>
            <p><strong>Date:</strong> {{ selectedSale?.saleDate | date:'mediumDate' }}</p>
            <p><strong>Invoice No:</strong> {{ selectedSale?.invoiceNo }}</p>
            <p><strong>Added By:</strong> {{ selectedSale?.addedByDisplayName || selectedSale?.addedBy || 'System' }}</p>
            <p><strong>Location:</strong> {{ selectedSale?.businessLocation || selectedSale?.location || 'N/A' }}</p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <h6>Status Information</h6>
            <p><strong>Order Status:</strong>
              <span class="badge" [ngClass]="{
                'bg-success': selectedSale?.status === 'Completed',
                'bg-warning': selectedSale?.status === 'Pending',
                'bg-danger': selectedSale?.status === 'Cancelled'
              }">
                {{ selectedSale?.status }}
              </span>
            </p>
            <p><strong>Payment Status:</strong>
              <span class="badge" [ngClass]="{
                'bg-success': selectedSale?.paymentStatus === 'Paid',
                'bg-warning': selectedSale?.paymentStatus === 'Partial',
                'bg-danger': selectedSale?.paymentStatus === 'Due'
              }">
                {{ selectedSale?.paymentStatus || 'N/A' }}
              </span>
            </p>
            <p><strong>Shipping Status:</strong> {{ selectedSale?.shippingStatus || 'N/A' }}</p>
          </div>
          <div class="col-md-6">
            <h6>Payment Information</h6>
            <p><strong>Payment Method:</strong> {{ selectedSale?.paymentMethod || 'N/A' }}</p>
            <p><strong>Payment Account:</strong> {{ selectedSale?.paymentAccountName || 'N/A' }}</p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12">
            <h6>Products</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Discount</th>
                    <th>Tax</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let product of selectedSale?.products; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ product.name || product.productName }}</td>
                    <td>{{ product.quantity }}</td>
                    <td>{{ product.unitPrice | currency:'INR':'symbol':'1.2-2' }}</td>
                    <td>{{ product.discount | currency:'INR':'symbol':'1.2-2' }}</td>
                    <td>{{ product.taxRate || 0 }}%</td>
                    <td>{{ product.subtotal | currency:'INR':'symbol':'1.2-2' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <h6>Shipping Information</h6>
      <p><strong>Shipping Address:</strong> {{ selectedSale?.shippingAddress || 'Same as billing' }}</p>
<p><strong>Shipping Details:</strong> {{ selectedSale?.shippingDetails || 'N/A' }}</p>
<p><strong>Shipping Charges (Incl. Tax):</strong>
              {{
                (selectedSale?.shippingCharges || 0) +
                ((selectedSale?.shippingCharges || 0) * ((selectedSale?.orderTax || 18) / 100))
                | currency:'INR':'symbol':'1.2-2'
              }}
            </p>          </div>
          <div class="col-md-6 text-end">
            <div class="totals">
              <p><strong>Subtotal:</strong> {{ selectedSale?.subtotal | currency:'INR':'symbol':'1.2-2' }}</p>
              <p><strong>Total Payable:</strong> {{ selectedSale?.totalPayable | currency:'INR':'symbol':'1.2-2' }}</p>
              <p><strong>Amount Paid:</strong> {{ selectedSale?.paymentAmount | currency:'INR':'symbol':'1.2-2' }}</p>
              <p><strong>Balance Due:</strong> {{ selectedSale?.balance | currency:'INR':'symbol':'1.2-2' }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="generateInvoice(selectedSale)">
          <i class="fa fa-file-text me-2"></i> Generate Invoice
        </button>
      </div>
    </div>
  </div>
</div><div class="modal fade" id="printInvoiceModal" tabindex="-1" aria-labelledby="printInvoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="printInvoiceModalLabel">Print Invoice #{{ selectedSale?.invoiceNo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="printInvoiceContent">
        <!-- Invoice Header -->
        <div class="invoice-print-header">
          <img src="assets/logo2.png" alt="Company Logo" class="logo">
          <div class="company-details">
            <h3>HERBALY TOUCH AYURVEDA PRODUCTS PRIVATE LIMITED</h3>
            <p>1st Floor, Chirackal Tower, Ayroor P.O, Emakulam, Kerala, 683579, India</p>
            <p>Mobile: 00917034110999 | GST: 32AAGCH3136H12X</p>
          </div>
        </div>

        <!-- Invoice Details -->
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Invoice No:</strong> {{ selectedSale?.invoiceNo || 'N/A' }}</p>
            <p><strong>Date:</strong> {{ (selectedSale?.saleDate | date:'mediumDate') || 'N/A' }}</p>
            <p><strong>Order No:</strong> {{ selectedSale?.orderNo || 'N/A' }}</p>
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Customer:</strong> {{ selectedSale?.customer || 'N/A' }}</p>
            <p>{{ selectedSale?.billingAddress || selectedSale?.shippingAddress || 'N/A' }}</p>
            <p>Mobile: {{ selectedSale?.customerPhone || 'N/A' }}</p>
          </div>
        </div>

        <div class="table-responsive mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Price (₹)</th>
                <th>Discount</th>
                <th>Taxable Value (₹)</th>
                <th>CGST (₹)</th>
                <th>SGST (₹)</th>
                <th>Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of selectedSale?.products; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ product.name || product.productName || 'Product' }}</td>
                <td>{{ product.quantity }} Nos.</td>
                <td class="text-end">{{ product.unitPrice || product.price | number:'1.2-2' }}</td>
                <td class="text-end">
                  {{ product.discount | number:'1.2-2' }}
                  <span *ngIf="product.discount > 0">({{ (product.discount / (product.unitPrice * product.quantity) * 100) | number:'1.2-2' }}%)</span>
                </td>
                <td class="text-end">{{ ((product.unitPrice * product.quantity) - product.discount) | number:'1.2-2' }}</td>
                <td class="text-end">{{ (product.cgstAmount || ((product.unitPrice * product.quantity - product.discount) * 0.09)) | number:'1.2-2' }} (9%)</td>
                <td class="text-end">{{ (product.sgstAmount || ((product.unitPrice * product.quantity - product.discount) * 0.09)) | number:'1.2-2' }} (9%)</td>
                <td class="text-end">{{ product.subtotal | number:'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- FIXED: Shipping Section - Separate base charge and tax -->
        <div class="row mb-3">
          <div class="col-8">
            <p>Shipping Charges</p>
          </div>
          <div class="col-4 text-end">
            <p>₹{{ (selectedSale?.shippingCharges || 0) | number:'1.2-2' }}</p>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-8">
            <p>Shipping Tax (18%)</p>
          </div>
          <div class="col-4 text-end">
            <p>₹{{ ((selectedSale?.shippingCharges || 0) * 0.18) | number:'1.2-2' }}</p>
          </div>
        </div>

        <!-- Totals -->
        <div class="row mb-4">
        <!-- In your invoice modal HTML -->
<div class="row mb-4">
  <div class="col-8 text-end">
    <p><strong>Total Taxable Value: </strong> {{ getTotalTaxableValue() | currency:'INR':'symbol':'1.2-2' }}</p>
    <p><strong>Total CGST : </strong> {{ getTotalCGST() | currency:'INR':'symbol':'1.2-2' }}</p>
    <p><strong>Total SGST : </strong> {{ getTotalSGST() | currency:'INR':'symbol':'1.2-2' }}</p>

    <p><strong>Grand Total: </strong> {{ getGrandTotal() | currency:'INR':'symbol':'1.0-0' }}</p>
  </div>
</div>
        </div>

        <!-- Payment Info -->
        <div class="row">
          <div class="col-12">
            <p><strong>Payment Method:</strong> {{ selectedSale?.paymentMethod || 'N/A' }}</p>
            <p><strong>Amount Paid:</strong> ₹{{ selectedSale?.paymentAmount | number:'1.2-2' }}</p>
            <p><strong>Balance Due:</strong> ₹{{ selectedSale?.balance | number:'1.2-2' }}</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4">
          <p>Thank you for your business!</p>
          <small class="text-muted">This is a computer generated invoice and does not require signature</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="printInvoiceNow()">
          <i class="fa fa-print"></i> Print Invoice
        </button>
      </div>
    </div>
  </div>
</div>
<h2>Sales</h2>
<div class="container">
 
  <!-- Existing filter, export, and search sections remain the same -->
    <!-- Improved Filter, Export, and Search sections -->
   
      <div class="row align-items-center">
  <div class="col-12">
    <h5 class="card-title mb-3">Sales Management</h5>
    
    <!-- Main row with search on left and buttons on right -->
   
<!-- Main row with search on left and buttons on right -->
<div class="row align-items-center mb-3">
  <!-- Search section - Left side -->
  <div class="col-md-6">
    <div class="input-group">
      <span class="input-group-text"><i class="fa fa-search"></i></span>
    <input type="text" class="form-control" placeholder="Search by customer, invoice, products..."
       [(ngModel)]="searchTerm" (keyup)="applyFilters()">
    </div>
  </div>
  <!-- INSERT THIS BLOCK HERE: Active Filter Chips -->
<div class="active-filters-display d-flex flex-wrap align-items-center gap-2 mb-3" *ngIf="getActiveFilters().length > 0">
  <small class="text-muted fw-bold me-2"><i class="fa fa-filter me-1"></i> Applied:</small>
  
  <div *ngFor="let filter of getActiveFilters()" class="badge rounded-pill bg-light text-dark border d-flex align-items-center px-3 py-2 shadow-sm">
    <span>{{ filter.label }}</span>
    <i class="fa fa-times ms-2 text-danger" style="cursor: pointer; font-size: 0.7rem;" 
       (click)="removeActiveFilter(filter.key)"></i>
  </div>

  <button class="btn btn-sm btn-link text-danger p-0 ms-2 text-decoration-none fw-bold" 
          (click)="resetSidebarFilters()">
    Clear All
  </button>
</div>
         
  <!-- Buttons section - Right side -->
  <div class="col-md-6">
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-light" type="button" (click)="toggleColumnMenu()">
        <i class="fa fa-columns"></i> Columns
      </button>
                     
      <button class="btn btn-info" (click)="toggleFilterSidebar()">
        <i class="fa fa-filter"></i> Filters
      </button>
      <button class="btn btn-primary" routerLink="/add-sale">
        <i class="fa fa-plus"></i> Add Sales Order
      </button>
    </div>
  </div>
</div>

<!-- Column Menu Dropdown - Centered Modal -->
<div class="column-menu-overlay" *ngIf="showColumnMenu" (click)="toggleColumnMenu()">
  <div class="column-menu-modal" (click)="$event.stopPropagation()">
    <div class="column-menu-header">
      <h6>Column Visibility</h6>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" (click)="resetColumnVisibility()">Reset</button>
        <button class="btn btn-sm btn-outline-danger" (click)="toggleColumnMenu()">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>
    <div class="column-options">
      <div *ngFor="let column of columns" class="form-check">
        <input class="form-check-input" type="checkbox"
               id="col-{{column.field}}"
               [(ngModel)]="column.visible"
               (change)="updateColumnVisibility()">
        <label class="form-check-label" for="col-{{column.field}}">
          {{column.header}}
        </label>
      </div>
    </div>
  </div>
</div>

    
    <!-- Export Dropdown Menu -->
    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
      <li><a class="dropdown-item" (click)="exportCSV()"><i class="fa fa-file-csv"></i> CSV</a></li>
      <li><a class="dropdown-item" (click)="exportExcel()"><i class="fa fa-file-excel"></i> Excel</a></li>
      <li><a class="dropdown-item" (click)="printData()"><i class="fa fa-print"></i> Print</a></li>
      <!-- Removed invalid reference to 'sale' outside of *ngFor context -->
      <!-- If you want a View History link for a specific sale, move this inside the table row's dropdown menu where 'sale' is defined -->
    
    </ul>
  </div>
</div>
    </div>
    <!-- Inside the card-body div, after the export section -->

<!-- Filter Sidebar -->
<!-- Filter Sidebar -->
<!-- Enhanced Filter Sidebar with Quick Date Filters -->
<div class="filter-sidebar" [class.show]="showFilterSidebar">
  <div class="sidebar-header">
    <h5>Filters</h5>
    <button class="btn btn-close" (click)="toggleFilterSidebar()"></button>
  </div>
  <div class="sidebar-body">
    <!-- Quick Date Filters -->
    <div class="mb-3">
      <label class="form-label">Quick Date Filters</label>
      <select class="form-select" [(ngModel)]="quickDateFilter" (change)="applyQuickDateFilter()">
        <option value="">Custom Date Range</option>
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="tomorrow">Tomorrow</option>
        <option value="thisWeek">This Week</option>
        <option value="lastWeek">Last Week</option>
        <option value="nextWeek">Next Week</option>
        <option value="thisMonth">This Month</option>
        <option value="lastMonth">Last Month</option>
        <option value="thisQuarter">This Quarter</option>
        <option value="lastQuarter">Last Quarter</option>
        <option value="thisYear">This Year</option>
        <option value="lastYear">Last Year</option>
        <option value="thisFinancialYear">This Financial Year</option>
        <option value="lastFinancialYear">Last Financial Year</option>
        <option value="last7Days">Last 7 Days</option>
        <option value="last30Days">Last 30 Days</option>
        <option value="last90Days">Last 90 Days</option>
      </select>
    </div>

    <!-- Custom Date Range Filters (shown when "Custom Date Range" is selected) -->
    <div class="mb-3" *ngIf="quickDateFilter === '' || quickDateFilter === null">
      <label class="form-label">Custom Date Range</label>
      <div class="row">
        <div class="col-6">
          <input type="date" class="form-control" placeholder="From Date" 
                [(ngModel)]="startDate" (change)="applyFilters()">
        </div>
        <div class="col-6">
          <input type="date" class="form-control" placeholder="To Date" 
                [(ngModel)]="endDate" (change)="applyFilters()">
        </div>
      </div>
    </div>
    

    <!-- Display selected date range info -->
    <div class="mb-3" *ngIf="quickDateFilter && getDateRangeDisplay()">
      <div class="alert alert-info py-2">
        <small><i class="fa fa-calendar"></i> {{ getDateRangeDisplay() }}</small>
      </div>
    </div>

<div class="mb-3">
  <label class="form-label">Status</label>
  <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
    <option value="">All Statuses</option>
    <option value="Completed">Completed</option>
    <!-- Removed Pending and Cancelled options -->
  </select>
</div>
    
    <div class="mb-3">
      <label class="form-label">Payment Method</label>
      <select class="form-select" [(ngModel)]="paymentMethodFilter" (change)="applyFilters()">
        <option value="">All Methods</option>
        <option value="Cash">Cash</option>
        <option value="Card">Card</option>
        <option value="Bank Transfer">Bank Transfer</option>
        <option value="Cheque">Cheque</option>
        <option value="Other">Other</option>
      </select>
    </div>

<!-- Incentive User (Agent) -->
<div class="mb-3">
  <label class="form-label">Incentive User</label>
  <select class="form-select" [(ngModel)]="addedByFilter" (change)="applyFilters()">
    <option value="">All Users</option>
    <option *ngFor="let user of users" [value]="user.id">
      {{ user.displayName }}
    </option>
  </select>
</div>

<!-- Location -->
<div class="mb-3">
  <label class="form-label">Location</label>
  <select class="form-select" [(ngModel)]="locationFilter" (change)="applyFilters()">
    <option value="">All Locations</option>
    <option *ngFor="let loc of businessLocations" [value]="loc.id">
      {{ loc.name }}
    </option>
  </select>
</div>

<!-- ADD THIS: Type of Service Filter -->
<div class="mb-3">
  <label class="form-label">Type of Service</label>
  <select class="form-select" [(ngModel)]="typeOfServiceFilter" (change)="applyFilters()">
    <option value="">All Service Types</option>
    <option *ngFor="let service of serviceTypes" [value]="service.id">
      {{ service.name }}
    </option>
  </select>
</div>




<div *ngIf="userAllowedLocations.length > 0" class="location-badge">
  <i class="fa fa-map-marker"></i> 
  Viewing data for: 
  <span *ngFor="let loc of userAllowedLocations; let last = last">
    {{ loc }}{{ !last ? ', ' : '' }}
  </span>
</div>

<div class="mb-3">
  <label class="form-label">Shipping Status</label>
  <select class="form-select" [(ngModel)]="shippingStatusFilter" (change)="applyFilters()">
    <option value="">All Shipping Statuses</option>
    <option value="Pending">On hold</option>
    <option value="Ordered">Ordered</option>
    <option value="Print">Print</option>
    <option value="Processing">Processing</option>
    <option value="Packed">Packed</option>
    <option value="Shipped">Shipped</option>
    <option value="Delivered">Delivered</option>
    <option value="Returned">Returned</option>
    <option value="Cancelled">Cancelled</option>
  </select>
</div>
    

    
    <button class="btn btn-outline-secondary w-100 mt-2" (click)="resetSidebarFilters()">
      <i class="fa fa-sync"></i> Reset Filters
    </button>
  </div>
</div>

<!-- <div class="mb-3">
      <label class="form-label">Location</label>
      <select class="form-select" [(ngModel)]="locationFilter" (change)="applyFilters()">
        <option value="">All Locations</option>
        <option *ngFor="let location of getUniqueLocations()" [value]="location">
          {{ location }}
        </option>
      </select>
    </div>
<div *ngIf="userAllowedLocations.length > 0" class="location-badge">
  <i class="fa fa-map-marker"></i> 
  Viewing data for: 
  <span *ngFor="let loc of userAllowedLocations; let last = last">
    {{ loc }}{{ !last ? ', ' : '' }}
  </span>
</div> -->
  <!-- Table section -->



  <div *ngIf="userAllowedLocations.length > 0" class="location-badge">
  <i class="fa fa-map-marker"></i> 
  Viewing data for: 
  <span *ngFor="let loc of userAllowedLocations; let last = last">
    {{ loc }}{{ !last ? ', ' : '' }}
  </span>
</div>

<!-- Enhanced table section with shipping breakdown columns in sales.component.html -->
<div class="table-responsive">
  <table class="table table-hover no-vertical-lines">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Actions</th>
        <th *ngIf="isColumnVisible('invoiceNo')" (click)="sortData('invoiceNo')">
          Invoice No <i class="fa" [ngClass]="getSortIconClass('invoiceNo')"></i>
        </th>
        <th *ngIf="isColumnVisible('saleDate')" (click)="sortData('saleDate')">
          Sale Date <i class="fa" [ngClass]="getSortIconClass('saleDate')"></i>
        </th>
        <th *ngIf="isColumnVisible('customer')" (click)="sortData('customer')">
          Customer <i class="fa" [ngClass]="getSortIconClass('customer')"></i>
        </th>
        <th *ngIf="isColumnVisible('customerPhone')" (click)="sortData('customerPhone')">
          Contact Number <i class="fa" [ngClass]="getSortIconClass('customerPhone')"></i>
        </th>
        <th *ngIf="isColumnVisible('products')" (click)="sortData('products')">
          Products <i class="fa" [ngClass]="getSortIconClass('products')"></i>
        </th>
        <th *ngIf="isColumnVisible('orderStatus')" (click)="sortData('orderStatus')">
          Order Status <i class="fa" [ngClass]="getSortIconClass('orderStatus')"></i>
        </th>
        <th *ngIf="isColumnVisible('typeOfService')" (click)="sortData('typeOfService')">
  Type of Service <i class="fa" [ngClass]="getSortIconClass('typeOfService')"></i>
</th>
        <th *ngIf="isColumnVisible('shippingStatus')" (click)="sortData('shippingStatus')">
          Shipping Status <i class="fa" [ngClass]="getSortIconClass('shippingStatus')"></i>
        </th>
        
        <!-- Enhanced shipping columns -->
        <th *ngIf="isColumnVisible('shippingCharges')" (click)="sortData('shippingCharges')">
          Shipping (Before Tax) <i class="fa" [ngClass]="getSortIconClass('shippingCharges')"></i>
        </th>
        <th *ngIf="isColumnVisible('shippingTax')" (click)="sortData('shippingTax')">
          Shipping Tax <i class="fa" [ngClass]="getSortIconClass('shippingTax')"></i>
        </th>
        <th *ngIf="isColumnVisible('shippingWithTax')" (click)="sortData('shippingWithTax')">
          Shipping (With Tax) <i class="fa" [ngClass]="getSortIconClass('shippingWithTax')"></i>
        </th>
        <th *ngIf="isColumnVisible('shippingReturned')" (click)="sortData('shippingReturned')">
          Shipping Returned <i class="fa" [ngClass]="getSortIconClass('shippingReturned')"></i>
        </th>
        
        <th *ngIf="isColumnVisible('paymentMethod')" (click)="sortData('paymentMethod')">
          Payment Method <i class="fa" [ngClass]="getSortIconClass('paymentMethod')"></i>
        </th>
        <th *ngIf="isColumnVisible('totalPayable')" class="text-end" (click)="sortData('totalPayable')">
          Total Payable <i class="fa" [ngClass]="getSortIconClass('totalPayable')"></i>
        </th>
        <th *ngIf="isColumnVisible('paymentAmount')" (click)="sortData('paymentAmount')">
          Payment Amount <i class="fa" [ngClass]="getSortIconClass('paymentAmount')"></i>
        </th>
        <th *ngIf="isColumnVisible('balance')" (click)="sortData('balance')">
          Balance <i class="fa" [ngClass]="getSortIconClass('balance')"></i>
        </th>
        <th *ngIf="isColumnVisible('paymentDue')" class="text-center" (click)="sortData('paymentDue')">
          Payment Due <i class="fa" [ngClass]="getSortIconClass('paymentDue')"></i>
        </th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let sale of filteredSales | slice: (currentPage-1)*entriesPerPage : currentPage*entriesPerPage; let i = index">
        <tr>
          <td>{{ (currentPage-1)*entriesPerPage + i + 1 }}</td>
          <td class="action-buttons">
            <div class="dropdown">
              <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="actionMenu{{i}}" data-bs-toggle="dropdown" aria-expanded="false">
                Actions
              </button>
              <ul class="dropdown-menu" [attr.aria-labelledby]="'actionMenu' + i">
                <li>
                  <a class="dropdown-item" href="javascript:void(0)" (click)="viewSaleDetails(sale)">
                    <i class="fa fa-eye me-2"></i> View Details
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="javascript:void(0)" (click)="generateInvoice(sale)">
                    <i class="fa fa-file-text me-2"></i> Generate Invoice
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="javascript:void(0)" (click)="initiateReturn(sale)">
                    <i class="fa fa-undo me-2"></i> Initiate Return
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-danger" href="javascript:void(0)" (click)="deleteSale(sale.id)">
                    <i class="fa fa-trash me-2"></i> Delete
                  </a>
                </li>
              </ul>
            </div>
          </td>
          <td *ngIf="isColumnVisible('invoiceNo')">{{ sale.invoiceNo }}</td>
<td *ngIf="isColumnVisible('saleDate')">
  {{ sale.saleDate | date:'dd/MM/yyyy' }}
</td>          <td *ngIf="isColumnVisible('customer')">{{ sale.customer }}</td>
          <td *ngIf="isColumnVisible('customerPhone')">{{ sale.customerPhone }}</td>
          <td *ngIf="isColumnVisible('products')">{{ getProductsDisplayText(sale.products) }}</td>

 <!-- Inside <tr *ngFor="let sale of filteredSales..."> in sales.component.html -->

<td *ngIf="isColumnVisible('orderStatus')">
  <span class="badge"
        [ngClass]="{
          'bg-success': sale.orderStatus === 'Completed',
          'bg-secondary': sale.orderStatus === 'Pending',
          'bg-danger': sale.orderStatus === 'Cancelled',
          'bg-info': sale.orderStatus === 'Partial Return'
        }">
    {{ sale.orderStatus || 'Pending' }}
  </span>
</td>
<td *ngIf="isColumnVisible('typeOfService')">{{ sale.typeOfService || 'N/A' }}</td>
    <!-- in sales.component.html -->

<!-- SHIPPING / RETURN STATUS Column -->
<!-- SHIPPING / RETURN STATUS Column in sales.component.html -->
<td *ngIf="isColumnVisible('shippingStatus')">
    <span class="badge px-2 py-1"
          [ngClass]="{
            'bg-success text-white': sale.shippingStatus === 'Delivered',
            'bg-info text-white': sale.shippingStatus === 'Shipped',
            'bg-secondary text-white': sale.status === 'Returned',
            'bg-primary text-white': sale.status === 'Partial Return',
            'bg-warning text-dark': sale.shippingStatus === 'Processing' || sale.shippingStatus === 'Pending' || !sale.shippingStatus,
            'bg-danger text-white': sale.shippingStatus === 'Cancelled',
            'bg-light text-dark border': sale.shippingStatus === 'N/A' || !sale.shippingStatus
          }">
      <!-- Fallback to 'Pending' or 'N/A' if value is missing -->
      {{ getShippingStatusWithReturns(sale) || 'N/A' }}
    </span>
</td>
          
          <!-- Enhanced shipping columns -->
          <td *ngIf="isColumnVisible('shippingCharges')" class="text-end">
            <span [class.text-muted]="!hasShippingCharges(sale)">
              ₹{{ getShippingChargeWithoutTax(sale) | number:'1.2-2' }}
            </span>
          </td>
          <td *ngIf="isColumnVisible('shippingTax')" class="text-end">
            <span [class.text-muted]="!hasShippingCharges(sale)">
              ₹{{ getShippingTaxAmount(sale) | number:'1.2-2' }}
              <small class="text-muted d-block" *ngIf="hasShippingCharges(sale)">
                ({{ sale.orderTax || 18 }}%)
              </small>
            </span>
          </td>
          <td *ngIf="isColumnVisible('shippingWithTax')" class="text-end">
            <span [class.text-muted]="!hasShippingCharges(sale)" [class.fw-bold]="hasShippingCharges(sale)">
              ₹{{ getShippingChargeWithTax(sale) | number:'1.2-2' }}
            </span>
          </td>
          <td *ngIf="isColumnVisible('shippingReturned')" class="text-end">
            <span *ngIf="getShippingReturnedAmount(sale) > 0; else noReturns" class="text-danger">
              ₹{{ getShippingReturnedAmount(sale) | number:'1.2-2' }}
            </span>
            <ng-template #noReturns>
              <span class="text-muted">₹0.00</span>
            </ng-template>
          </td>
          
          <td *ngIf="isColumnVisible('paymentMethod')">{{ sale.paymentMethod || 'N/A' }}</td>
          <td *ngIf="isColumnVisible('totalPayable')" class="text-end">₹{{ roundAmount(sale.totalPayable) | number:'1.0-0' }}</td>
          <td *ngIf="isColumnVisible('paymentAmount')">₹{{ roundAmount(sale.paymentAmount) | number:'1.0-0' }}</td>
          <td *ngIf="isColumnVisible('balance')">₹{{ sale.balance | number:'1.2-2' }}</td>
          <td *ngIf="isColumnVisible('paymentDue')" class="text-center">
            <span class="badge"
                  [ngClass]="{
                    'bg-success': sale.paymentStatus === 'Paid',
                    'bg-danger': sale.paymentStatus === 'Due',
                    'bg-warning': sale.paymentStatus === 'Partial'
                  }">
              {{ sale.paymentStatus || 'Due' }}
            </span>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>
   <!-- Table footer with all totals -->
<!-- Updated table footer with shipping breakdown in sales.component.html -->
<div class="tablefooter mt-3">
  <div class="row">
    <!-- Left side - Status counts -->
    <div class="col-md-6">
      <!-- Payment Status Summary -->
      <div *ngIf="isColumnVisible('paymentDue')" class="mb-3">
        <h6 class="fw-bold">Payment Status Summary</h6>
        <div class="d-flex flex-wrap gap-2">
          <span class="badge bg-success">Paid: {{getPaymentStatusCount('Paid')}}</span>
          <span class="badge bg-danger">Due: {{getPaymentStatusCount('Due')}}</span>
          <span class="badge bg-warning text-dark">Partial: {{getPaymentStatusCount('Partial')}}</span>
        </div>
      </div>

      <!-- Payment Method Summary -->
      <div *ngIf="isColumnVisible('paymentMethod')" class="mb-3">
        <h6 class="fw-bold">Payment Methods</h6>
        <div class="d-flex flex-wrap gap-2">
          <span *ngFor="let method of getPaymentMethodSummary()" class="badge bg-info text-dark">
            {{method.method}}: {{method.count}}
          </span>
        </div>
      </div>
    </div>

    <!-- Right side - Enhanced numeric totals with shipping breakdown -->
    <div class="col-md-6">
      <table class="table table-sm table-borderless float-end">
        <tbody>
          <!-- Sales totals -->
          <tr class="table-info">
            <td class="text-end fw-bold">Sales (Without Tax & Shipping):</td>
            <td class="text-end fw-bold">₹{{ totalSalesWithoutTax | number:'1.2-2' }}</td>
          </tr>
          
          <!-- Shipping breakdown -->
          <tr *ngIf="isColumnVisible('shippingCharge')">
            <td class="text-end">Shipping Charges (Before Tax):</td>
            <td class="text-end">₹{{ totalShippingCharge | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="isColumnVisible('shippingCharge')">
            <td class="text-end">Shipping Tax:</td>
            <td class="text-end">₹{{ totalShippingTax | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="isColumnVisible('shippingCharge')">
            <td class="text-end">Shipping Charges (With Tax):</td>
            <td class="text-end">₹{{ totalShippingWithTax | number:'1.2-2' }}</td>
          </tr>
          
          <!-- Total sales with shipping -->
          <tr class="table-success">
            <td class="text-end fw-bold">Total Sales (With Shipping & Tax):</td>
            <td class="text-end fw-bold">₹{{ totalSalesWithShippingTax | number:'1.2-2' }}</td>
          </tr>
          
          <tr><td colspan="2"><hr class="my-2"></td></tr>
          
          <!-- Payment totals -->
          <tr *ngIf="isColumnVisible('paymentAmount')">
            <td class="text-end fw-bold">Payment Amount Total:</td>
            <td class="text-end">₹{{ totalPaymentAmount | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="isColumnVisible('balance')">
            <td class="text-end fw-bold">Balance Total:</td>
            <td class="text-end">₹{{ totalBalance | number:'1.2-2' }}</td>
          </tr>
          <tr *ngIf="isColumnVisible('paymentDue')">
            <td class="text-end fw-bold">Total Due Amount:</td>
            <td class="text-end">₹{{ totalDueAmount | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
  
  <div class="modal fade" id="saleDetailsModal" tabindex="-1" aria-labelledby="saleDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="saleDetailsModalLabel">Sale Details - Invoice #{{ selectedSale?.invoiceNo }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <h6>Customer Information</h6>
              <p><strong>Name:</strong> {{ selectedSale?.customer }}</p>
              <p><strong>Contact:</strong> {{ selectedSale?.customerPhone }}</p>
              <p><strong>Email:</strong> {{ selectedSale?.customerEmail }}</p>
            </div>
            <div class="col-md-6">
              <h6>Order Information</h6>
              <p><strong>Date:</strong> {{ selectedSale?.saleDate | date:'mediumDate' }}</p>
              <p><strong>Added By:</strong> {{ selectedSale?.addedByDisplayName || selectedSale?.addedBy || 'System' }}</p>
              <p><strong>Status:</strong> 
                <span class="badge" [ngClass]="{
                  'bg-success': selectedSale?.status === 'Completed',
                  'bg-warning': selectedSale?.status === 'Pending',
                  'bg-danger': selectedSale?.status === 'Cancelled',
                  'bg-primary': selectedSale?.status === 'Active'  
                }">
                  {{ selectedSale?.status }}
                </span>
              </p>
              <p><strong>Commission:</strong> {{ selectedSale?.commissionPercentage || 0 }}%</p>
              <p><strong>Shipping:</strong> {{ selectedSale?.shippingStatus }}</p>
            </div>
          </div>
          
          
          <div class="row mb-3">
            <div class="col-12">
              <h6>Items</h6>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngIf="selectedSale?.products?.length > 0; else showItems">
                    <tr *ngFor="let product of selectedSale?.products">
                      <td>{{ product.name }}</td>
                      <td>{{ product.quantity }}</td>
                      <td>₹{{ product.unitPrice | number:'1.2-2' }}</td>
                      <td>₹{{ product.subtotal | number:'1.2-2' }}</td>
                    </tr>
                  </ng-container>
                  <ng-template #showItems>
                    <tr *ngFor="let item of selectedSale?.items">
                      <td>{{ item.name }}</td>
                      <td>{{ item.quantity }}</td>
                      <td>₹{{ item.price | number:'1.2-2' }}</td>
                      <td>{{ item.commissionPercent || 0 }}%</td>
                      <td>₹{{ (item.price * item.quantity) | number:'1.2-2' }}</td>
                    </tr>
                  </ng-template>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <h6>Shipping Information</h6>
              <p>{{ selectedSale?.shippingAddress }}</p>
            </div>
            <div class="col-md-6 text-end">
              <div class="totals">
                <p><strong>Subtotal:</strong> ₹{{ selectedSale?.subtotal | number:'1.2-2' }}</p>
                <p><strong>Tax:</strong> ₹{{ selectedSale?.tax | number:'1.2-2' }}</p>
                <p><strong>Shipping:</strong> ₹{{ selectedSale?.shippingCost | number:'1.2-2' }}</p>
                <p><strong>Total:</strong> ₹{{ selectedSale?.total | number:'1.2-2' }}</p>
                <p><strong>Paid:</strong> ₹{{ selectedSale?.paymentAmount | number:'1.2-2' }}</p>
                <p><strong>Balance:</strong>₹{{ selectedSale?.balance | number:'1.2-2' }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" (click)="printInvoice()">
            <i class="fa fa-print"></i> Print Invoice
          </button>
        </div>
      </div>
    </div>
  </div>
<!-- src/app/sales/sales.component.html -->
<!-- src/app/sales/sales.component.html -->

<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="invoiceModalLabel">Invoice #{{ invoiceData.invoiceNo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invoicePrintContent">
        <!-- Invoice Header and Customer Details -->
        <div class="invoice-print-header">
          <img src="assets/logo2.png" alt="Company Logo" class="logo">
          <div class="company-details">
            <h3>HERBALY TOUCH AYURVEDA PRODUCTS PRIVATE LIMITED</h3>
            <p>1st Floor, Chirackal Tower, Ayroor P.O, Emakulam, Kerala, 683579, India</p>
            <p>Mobile: 00917034110999 | GST: 32AAGCH3136H12X</p>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Invoice No:</strong> {{ invoiceData.invoiceNo }}</p>
            <p><strong>Date:</strong> {{ invoiceData.date | date:'mediumDate' }}</p>
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Customer:</strong> {{ invoiceData.to.name }}</p>
            <p>{{ invoiceData.to.address }}</p>
            <p>Mobile: {{ invoiceData.to.mobile }}</p>
          </div>
        </div>

        <!-- Products Table with Dynamic Columns -->
        <div class="table-responsive mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Price (₹)</th>
                <th>Discount</th>
                <th>Taxable Value (₹)</th>
                
                <!-- ======================= CONDITIONAL HEADERS (THE FIX) ======================= -->
                <th *ngIf="invoiceHasCgstSgst">CGST (₹)</th>
                <th *ngIf="invoiceHasCgstSgst">SGST (₹)</th>
                <th *ngIf="invoiceHasIgst">IGST (₹)</th>
                <!-- ===================== END OF CONDITIONAL HEADERS ==================== -->
                
                <th>Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of invoiceData.products; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.quantity }} Nos.</td>
                <td class="text-end">{{ product.unitPrice | number:'1.2-2' }}</td>
                <td class="text-end">{{ product.discount | number:'1.2-2' }}</td>
                <td class="text-end">{{ product.taxableValue | number:'1.2-2' }}</td>

                <!-- ======================= CONDITIONAL DATA CELLS (THE FIX) ======================= -->
                <td *ngIf="invoiceHasCgstSgst" class="text-end">{{ product.cgstAmount | number:'1.2-2' }} ({{ product.cgstRate | number:'1.2-2' }}%)</td>
                <td *ngIf="invoiceHasCgstSgst" class="text-end">{{ product.sgstAmount | number:'1.2-2' }} ({{ product.sgstRate | number:'1.2-2' }}%)</td>
                <td *ngIf="invoiceHasIgst" class="text-end">{{ product.igstAmount | number:'1.2-2' }} ({{ product.igstRate | number:'1.2-2' }}%)</td>
                <!-- ===================== END OF CONDITIONAL DATA CELLS ==================== -->

                <td class="text-end">{{ product.subtotal | number:'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totals Section -->
        <div class="row mb-4">
          <div class="col-md-6">
            <!-- This column can be used for notes or QR codes if needed -->
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Total Taxable Value: </strong> <strong>₹{{ invoiceData.totalTaxableValue | number:'1.2-2' }}</strong></p>
            
            <!-- ======================= CONDITIONAL TOTALS (THE FIX) ======================= -->
            <p *ngIf="invoiceHasCgstSgst"><strong>Total CGST: </strong> <strong>₹{{ getTotalCGST() | number:'1.2-2' }}</strong></p>
            <p *ngIf="invoiceHasCgstSgst"><strong>Total SGST: </strong> <strong>₹{{ getTotalSGST() | number:'1.2-2' }}</strong></p>
            <p *ngIf="invoiceHasIgst"><strong>Total IGST: </strong> <strong>₹{{ getTotalIGST() | number:'1.2-2' }}</strong></p>
            <!-- ===================== END OF CONDITIONAL TOTALS ==================== -->
            
            <p><strong>Grand Total: </strong> <strong>₹{{ getGrandTotal() | number:'1.0-0' }}</strong></p>
          </div>
        </div>

        <!-- Payment Info and Footer -->
        <div class="row">
          <div class="col-12">
            <p><strong>Payment Method:</strong> {{ selectedSale?.paymentMethod || 'N/A' }}</p>
            <p><strong>Amount Paid:</strong> ₹{{ selectedSale?.paymentAmount | number:'1.2-2' }}</p>
            <p><strong>Balance Due:</strong> ₹{{ selectedSale?.balance | number:'1.2-2' }}</p>
          </div>
        </div>
        <div class="text-center mt-4">
          <p>Thank you for your business!</p>
          <small class="text-muted">This is a computer generated invoice and does not require signature</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="printGeneratedInvoice()">
          <i class="fa fa-print"></i> Print Invoice
        </button>
      </div>
    </div>
  </div>
</div>
<div class="row mt-3">
  <div class="col pagination-info">
    Showing {{ (currentPage-1)*entriesPerPage + 1 }} to 
    {{ currentPage*entriesPerPage > totalEntries ? totalEntries : currentPage*entriesPerPage }} 
    of {{ totalEntries }} entries
  </div>
  <div class="col pagination-controls">
    <button class="btn btn-light btn-sm me-2" 
            [disabled]="currentPage === 1" 
            (click)="previousPage()">
      <i class="fa fa-chevron-left"></i> Previous
    </button>
    <span class="page-numbers">
      Page {{ currentPage }} of {{ Math.ceil(totalEntries/entriesPerPage) }}
    </span>
    <button class="btn btn-light btn-sm ms-2" 
            [disabled]="currentPage*entriesPerPage >= totalEntries" 
            (click)="nextPage()">
      Next <i class="fa fa-chevron-right"></i>
    </button>
  </div>
</div>