<div class="controls-panel">
  <div class="controls-wrapper">
    <h2>Shipments</h2>
    <!-- Left Side -->
    <div class="controls-left">
   

      <div class="entries-control">
        <span>Show</span>
        <select (change)="changeEntriesPerPage($event)">
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span>entries</span>
      </div>
    </div>

    <!-- Right Side -->
    <div class="controls-right">
      <button class="filter-btn" (click)="toggleFilters()">
        <i class="fas fa-filter"></i> Filters
      </button>
  <button class="export-btn" (click)="exportCSV()">
        <i class="fas fa-file-csv"></i> CSV
      </button>
 <button class="export-btn" (click)="exportCSV()">
        <i class="fas fa-file-csv"></i>Excel
      </button>
      <button class="btn btn-primary" (click)="bulkPrintSelected()">
        <i class="fas fa-print"></i>
        Print Bulk
        <span class="count-badge">{{selectedShipments.length}}</span>
      </button>


      <button type="button" class="btn btn-primary" (click)="generateBulkDocuments('packing-slip')" [disabled]="selectedShipments.length === 0">
  <i class="fas fa-box"></i> Bulk Packing Slips
</button>

      <button type="button" class="btn btn-primary" (click)="generateBulkDocuments('invoice')" [disabled]="selectedShipments.length === 0">
        <i class="fas fa-file-invoice"></i> Bulk Invoices
      </button>

 
      <!-- Add this button with your other export buttons -->
      <button class="export-btn" (click)="toggleColumnVisibilityDropdown()">
        <i class="fas fa-columns"></i> Columns
      </button>
      
      <!-- Add this dropdown menu right after the button -->
      <div class="dropdown-menu" [class.show]="showColumnDropdown" style="min-width: 200px; padding: 10px;">
        <div class="form-check" *ngFor="let column of columns">
          <input class="form-check-input" type="checkbox" 
                 [id]="'col-' + column.id" 
                 [(ngModel)]="column.visible"
                 (change)="updateVisibleColumns()">
          <label class="form-check-label" [for]="'col-' + column.id">
            {{ column.name }}
          </label>
        </div>
      </div>
      
      
<div class="input-group input-group-sm search-container">
  <input
    type="text"
    class="form-control search-input"
    placeholder="Search invoices, customers, contacts..."
    [(ngModel)]="searchTerm"
    (keyup)="onSearch()"
  />
  <button class="btn btn-outline-secondary search-btn" type="button" (click)="onSearch()">
    <i class="fas fa-search"></i>
  </button>
</div>
    </div>
  </div>
</div>
<!-- Filter Sidebar - Added to right side -->
<div class="filter-sidebar" [class.show]="showFilters">
  <div class="filter-header">
    <h5>Filter Shipments</h5>
    <button type="button" class="close-btn" (click)="toggleFilters()">
      <i class="fas fa-times"></i>
    </button>
  </div>
<div class="filter-sidebar" [class.show]="showFilters">
  <div class="filter-header">
    <h5>Filter Shipments</h5>
    <button type="button" class="close-btn" (click)="toggleFilters()">
      <i class="fas fa-times"></i>
    </button>
  </div>
      <div class="mb-3">
      <label class="form-label">Quick Date Filters</label>
      <div class="btn-group-vertical w-100">
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('today')">Today</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('yesterday')">Yesterday</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('last7days')">Last 7 Days</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('last30days')">Last 30 Days</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('thisMonth')">This Month</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('lastMonth')">Last Month</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('thisFinancialYear')">This Financial Year</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="selectDatePreset('lastFinancialYear')">Last Financial Year</button>
      </div>
    </div>
  <div class="filter-body">
    <div class="mb-3">
      <label class="form-label">Date Range</label>
      <div class="input-group">
        <input type="date" class="form-control" [(ngModel)]="filterValues.startDate">
        <span class="input-group-text">to</span>
        <input type="date" class="form-control" [(ngModel)]="filterValues.endDate">
      </div>
    </div>


   

    <div class="mb-3">
      <label class="form-label">Type of Service</label>
      <select class="form-select" [(ngModel)]="filterValues.typeOfService">
        <option value="All">All Services</option>
        <option *ngFor="let service of typeOfServices" [value]="service.id">
          {{ service.name }}
        </option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Added By</label>
      <select class="form-select" [(ngModel)]="filterValues.addedBy">
        <option value="All">All Users</option>
        <option *ngFor="let user of users" [value]="user.id">
          {{ user.displayName || user.email }}
        </option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Payment Status</label>
      <select class="form-select" [(ngModel)]="filterValues.paymentStatus">
        <option value="All">All Statuses</option>
        <option value="Paid">Paid</option>
        <option value="Partial">Partial</option>
        <option value="Unpaid">Unpaid</option>
      </select>
    </div>

<div class="mb-3">
  <label class="form-label">Shipping Status</label>
  <select class="form-select" [(ngModel)]="filterValues.shippingStatus" name="shippingStatus">
   <option value="">All Statuses</option>
        <option value="Shipped">Ordered</option>
        <option value="Delivered">Print</option>
        <option value="Returned">Processing</option>
        <option value="Returned">Packed</option>
            <option value="Returned">shipped</option>
             <option value="Returned">Delivered</option>
    
  </select>
</div>
  </div>
  <div class="filter-footer">
    <button type="button" class="btn btn-secondary" (click)="resetFilters()">Reset</button>
    <button type="button" class="btn btn-primary" (click)="applyFilters()">Apply</button>
  </div>
</div>
</div>
<div class="filter-overlay" [class.show]="showFilters" (click)="toggleFilters()"></div>
<div class="card" (clickOutside)="showColumnDropdown = false">


  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
       <table class="table table-striped table-hover mb-0">
<thead>
  <tr class="text-nowrap">
    <!-- Static Columns -->
    <th><input type="checkbox" (change)="selectAll($event)"></th>
    <th>Action</th>

    <!-- Dynamic Columns from Component -->
    <th *ngIf="isColumnVisible('date')">Date <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('invoiceNo')">Invoice No. <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('customer')">Customer <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('contactNumber')">Contact <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('alternateContact')">Alternate Contact <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('location')">Current Location <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('billingAddress')">Billing Location <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('state')">State <i class="fas fa-sort"></i></th>
<th *ngIf="isColumnVisible('district')">District <i class="fas fa-sort"></i></th>  <th *ngIf="isColumnVisible('pincode')">Pincode <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('shippingDetails')">Shipping Details <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('typeOfService')">Type of Service <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('quantity')">Quantity <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('shippingCharge')">Shipping Charge <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('grandTotal')">Grand Total <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('shippingStatus')">Shipping Status <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('paymentStatus')">Payment Status <i class="fas fa-sort"></i></th>
    <th *ngIf="isColumnVisible('addedBy')">Added By <i class="fas fa-sort"></i></th>
  </tr>
</thead>

<tbody>
  <!-- Row for when no data is available - PARSER ERROR IS FIXED HERE -->

  <!-- Loop through shipments -->
  <tr *ngFor="let shipment of filteredShipments.slice((currentPage-1)*entriesPerPage, currentPage*entriesPerPage)">
    <!-- Checkbox Cell -->
    <td><input type="checkbox" [checked]="isSelected(shipment.id)" (change)="toggleSelection(shipment.id)"></td>
    
    <!-- Action Cell with Popup -->
    <td>
      <button class="action-button" (click)="openActionPopup(shipment, $event)">Actions</button>
      <div class="action-popup-overlay" *ngIf="currentActionPopup === shipment.id" (click)="closeActionPopup()">
        <div class="action-popup" (click)="$event.stopPropagation()">
          <div class="popup-header">
            <h4>Shipment #{{shipment.invoiceNo}}</h4>
            <button class="close-btn" (click)="closeActionPopup()">×</button>
          </div>
          <div class="popup-body">
            <div class="action-item" [routerLink]="['/shipments/view', shipment.id]"><i class="fas fa-eye text-info"></i><span>View</span></div>
            <div class="action-item" (click)="openEditFormModal(shipment); closeActionPopup()"><i class="fas fa-edit text-primary"></i><span>Edit</span></div>
            <div class="action-item" (click)="openEditModal(shipment); closeActionPopup()"><i class="fas fa-money-bill-wave text-warning"></i><span>Edit Payment Status</span></div>
            <div class="action-item" (click)="generatePackingSlip(shipment.id); closeActionPopup()"><i class="fas fa-box-open text-secondary"></i><span>Packing Slip</span></div>
            <div class="action-item" (click)="generateInvoice(shipment); closeActionPopup()"><i class="fas fa-file-invoice text-success"></i><span>Generate Invoice</span></div>
            <div class="action-item" (click)="viewPrescription(shipment); closeActionPopup()" [class.disabled]="!shipment.prescriptions || shipment.prescriptions.length === 0" [title]="(!shipment.prescriptions || shipment.prescriptions.length === 0) ? 'No prescription available' : ''"><i class="fas fa-file-prescription text-info"></i><span>View Prescription</span></div>
            <div class="action-item" (click)="printShipment(shipment); closeActionPopup()"><i class="fas fa-print text-secondary"></i><span>Print</span></div>
            <div class="divider"></div>
            <div class="action-item text-danger" (click)="confirmDelete(shipment); closeActionPopup()"><i class="fas fa-trash-alt"></i><span>Delete</span></div>
          </div>
        </div>
      </div>
    </td>

    <!-- Dynamic Data Cells -->
    <td *ngIf="isColumnVisible('date')">{{ formatDateForDisplay(shipment.date) }}</td>
    <td *ngIf="isColumnVisible('invoiceNo')">{{ shipment.invoiceNo }}</td>
    <td *ngIf="isColumnVisible('customer')">{{ shipment.customer }}</td>
    <td *ngIf="isColumnVisible('contactNumber')">{{ shipment.contactNumber }}</td>
    <td *ngIf="isColumnVisible('alternateContact')">{{ shipment.alternateContact || 'N/A' }}</td>
    <td *ngIf="isColumnVisible('location')">{{ shipment.location }}</td>
    <td *ngIf="isColumnVisible('billingAddress')">{{ shipment.billingAddress || 'N/A' }}</td>
    <td *ngIf="isColumnVisible('state')">{{ parseAddress(shipment.billingAddress, 'state') }}</td>
      <td *ngIf="isColumnVisible('district')">{{ shipment.district || parseAddress(shipment.billingAddress, 'district') }}</td>    <td *ngIf="isColumnVisible('pincode')">{{ parseAddress(shipment.billingAddress, 'pincode') }}</td>
    <td *ngIf="isColumnVisible('shippingDetails')">{{ shipment.shippingDetails || 'N/A' }}</td>
    <td *ngIf="isColumnVisible('typeOfService')">{{ shipment.typeOfServiceName || shipment.typeOfService || 'Standard' }}</td>
    <td *ngIf="isColumnVisible('quantity')">{{ getShipmentTotalQuantity(shipment) }}</td>
    <td *ngIf="isColumnVisible('shippingCharge')">{{ shipment.shippingCharge | currency:'INR':'symbol':'1.2-2' }}</td>
<td *ngIf="isColumnVisible('grandTotal')">{{ shipment.totalPayable | currency:'INR':'symbol':'1.0-0' }}</td><td *ngIf="isColumnVisible('shippingStatus')">
  <span [ngClass]="getStatusBadgeClass(shipment.shippingStatus)">
    {{ shipment.shippingStatus || 'N/A' }}
  </span>
</td>
    <td *ngIf="isColumnVisible('paymentStatus')">
      <span [ngClass]="{
        'badge bg-danger': shipment.paymentStatus === 'Unpaid',
        'badge bg-warning': shipment.paymentStatus === 'Partial',
        'badge bg-success': shipment.paymentStatus === 'Paid'
      }">{{ shipment.paymentStatus }}</span>
    </td>
    <td *ngIf="isColumnVisible('addedBy')">{{ shipment.addedByDisplayName || shipment.addedBy || 'System' }}</td>
  </tr>
</tbody>

<tfoot class="table-active font-weight-bold">
  <tr>
    <td colspan="2" class="text-end fw-bold">Total Shipments:</td>
    <td *ngIf="isColumnVisible('date')"></td>
    <td *ngIf="isColumnVisible('invoiceNo')"></td>
    <td *ngIf="isColumnVisible('customer')"></td>
    <td *ngIf="isColumnVisible('contactNumber')"></td>
    <td *ngIf="isColumnVisible('alternateContact')"></td>
    <td *ngIf="isColumnVisible('location')"></td>
    <td *ngIf="isColumnVisible('billingAddress')"></td>
    <td *ngIf="isColumnVisible('state')"></td>
    <td *ngIf="isColumnVisible('district')"></td>
    <td *ngIf="isColumnVisible('pincode')"></td>
    <td *ngIf="isColumnVisible('shippingDetails')"></td>
    <td *ngIf="isColumnVisible('typeOfService')"></td>
    <td *ngIf="isColumnVisible('quantity')" class="fw-bold">{{ totalShipmentCount }}</td>
    <td *ngIf="isColumnVisible('shippingCharge')"></td>
    <td *ngIf="isColumnVisible('grandTotal')" class="fw-bold">₹{{ totalShipmentAmount | number:'1.2-2' }}</td>
    <td *ngIf="isColumnVisible('shippingStatus')"></td>
    <td *ngIf="isColumnVisible('paymentStatus')"></td>
    <td *ngIf="isColumnVisible('addedBy')"></td>
  </tr>
</tfoot>
</table>
      </div>
    </div>
    
    <div class="card-footer bg-white">
      <div class="row align-items-center">
        <div class="col-md-6">
          Showing {{ filteredShipments.length ? (currentPage - 1) * entriesPerPage + 1 : 0 }} to 
          {{ getMinValue(currentPage * entriesPerPage, totalEntries) }} of {{ totalEntries }} entries
        </div>
        <div class="col-md-6">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-end mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="previousPage()">Previous</button>
              </li>
              <li class="page-item" *ngFor="let page of getPagesArray()" [class.active]="page === currentPage">
                <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage >= getTotalPages()">
                <button class="page-link" (click)="nextPage()">Next</button>
              </li>
              
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
<!-- Add this below your table -->
<div class="mt-3" *ngIf="selectedShipments.length > 0">
  <button class="btn btn-primary" (click)="openBulkStatusModal()">
    Change Shipping Status ({{selectedShipments.length}} selected)
  </button>

>




</div>


<!-- Updated prescription modal with fixed kasayam_combination case -->
<div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="prescriptionModalLabel">
          Prescription Details
          <span *ngIf="hasMultiplePrescriptions()" class="badge bg-info ms-2">
            {{ getCurrentPrescriptionInfo() }}
          </span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Navigation buttons for multiple prescriptions -->
      <div class="modal-header border-bottom-0 pt-0" *ngIf="hasMultiplePrescriptions()">
        <div class="d-flex justify-content-between w-100">
          <button type="button" 
                  class="btn btn-outline-primary btn-sm" 
                  (click)="previousPrescription()"
                  [disabled]="currentPrescriptionIndex === 0">
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          
          <span class="align-self-center">
            Viewing {{ currentPrescriptionIndex + 1 }} of {{ allPrescriptions.length }} prescriptions
          </span>
          
          <button type="button" 
                  class="btn btn-outline-primary btn-sm" 
                  (click)="nextPrescription()"
                  [disabled]="currentPrescriptionIndex === allPrescriptions.length - 1">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <div class="modal-body" id="prescriptionPrintContent">
        <!-- Prescription content will be dynamically generated -->
        <div *ngIf="currentPrescriptionData">
          <!-- Header Section -->
          <div class="text-center mb-4 prescription-header border-bottom pb-3">
                    <div class="logo-container">
            <img src="/assets/logo2.png">
          </div>
            <h3 class="text-primary fw-bold">HERBALLY TOUCH AYURVEDA PRODUCTS PVT.LTD</h3>
            <p class="mb-1"><strong>First Floor, Chirackal Tower, Ayroor P.O., Ernakulam Dt., Kerala - 683 579</strong></p>
            <p class="mb-1"><strong>E-mail: contact&#64;herballytouch.com | Ph: 7034110999</strong></p>
            <h4 class="text-success mt-2"><strong>DR RANJANA P.R.BAMS</strong></h4>
          </div>
          
          <!-- Patient Information -->
          <div class="row mb-4 patient-info bg-light p-3 rounded">
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label fw-bold">പേര് (Name):</label>
                <p class="fw-bold">{{ currentPrescriptionData.patientName || 'Not specified' }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label fw-bold">Age:</label>
                <p class="fw-bold">{{ currentPrescriptionData.patientAge || 'Not specified' }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label fw-bold">തീയതി (Date):</label>
                <p class="fw-bold">{{ currentPrescriptionData.date | date:'mediumDate' }}</p>
              </div>
            </div>
          </div>
          
          <!-- Medicines Section -->
          <div class="prescription-medicines" *ngIf="currentPrescriptionData.medicines && currentPrescriptionData.medicines.length > 0">
            <h4 class="mb-3 border-bottom pb-2">PRESCRIPTION</h4>
            <div *ngFor="let medicine of currentPrescriptionData.medicines; let i = index" 
                 class="medicine-item mb-4 p-3 border rounded shadow-sm bg-white">
              
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                  <span class="badge bg-primary me-2">{{i + 1}}</span>
                  {{getMedicineTypeName(medicine.type)}}
                </h5>
              </div>
              
              <!-- Medicine Details based on type -->
              <div [ngSwitch]="medicine.type">
                <!-- Kasayam Display -->
                <div *ngSwitchCase="'kasayam'" class="kasayam-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> കഷായം {{medicine.instructions}}ml എടുത്ത് 
                    {{medicine.quantity}}ml തിളപ്പിച്ചാറ്റിയവെള്ളം ചേർത്ത് 
                    {{medicine.powder}} ഗുളിക പൊടിച്ച്ചേർത്ത് 
                    {{medicine.pills}} നേരം മുമ്പ് സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Kasayam Combination Display - FIXED -->
                <div *ngSwitchCase="'kasayam_combination'" class="kasayam-combination-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong>കഷായം {{medicine.quantity || ''}} ml എടുത്ത്
                    {{medicine.combinationQuantity || ''}} ml തിളപ്പിച്ചാറ്റിയവെള്ളം ചേർത്ത്
                    {{medicine.combinationName || ''}}ഗുളിക പൊടിച്ച്ചേർത്ത്
                    {{medicine.frequency || ''}} ശേഷം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Buligha Display -->
                <div *ngSwitchCase="'buligha'" class="buligha-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> ഗുളിക {{medicine.instructions}} എണ്ണം എടുത്ത് 
                    {{medicine.powder}} നേരം മുമ്പ് സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Bhasmam Display -->
                <div *ngSwitchCase="'bhasmam'" class="bhasmam-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> ഭസ്മം {{medicine.dosage}} എടുത്ത് {{medicine.quantity}}ml 
                    {{medicine.instructions}} ചേർത്ത് {{medicine.powder}} നേരം ശേഷം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Krudham Display -->
                <div *ngSwitchCase="'krudham'" class="krudham-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> ഘൃതം ഒരു ടീ - സ്പൂൺ എടുത്ത് {{medicine.instructions}} നേരം ശേഷം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Suranam Display -->
                <div *ngSwitchCase="'suranam'" class="suranam-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> ചൂർണ്ണം {{medicine.instructions}} എടുത്ത് {{medicine.powder}} ചേർത്ത് തിളപ്പിച്ച് 
                    {{medicine.dosage}} നേരം ശേഷം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Rasayanam Display -->
                <div *ngSwitchCase="'rasayanam'" class="rasayanam-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> രസായനം ഒരു ടീ - സ്പൂൺ എടുത്ത് {{medicine.instructions}} നേരം ശേഷം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Lagium Display -->
                <div *ngSwitchCase="'lagium'" class="lagium-display">
                  <p class="malayalam-text mb-2">
                    <strong>{{medicine.name}}</strong> ലേഹ്യം {{medicine.instructions}} എടുത്ത് {{medicine.dosage}} നേരം നേരം സേവിക്കുക.
                  </p>
                </div>
                
                <!-- Default Display for other types -->
                <div *ngSwitchDefault>
                  <p class="mb-2">
                    <strong>Medicine:</strong> {{medicine.name}}<br>
                    <strong>Dosage:</strong> {{medicine.dosage}}<br>
                    <strong>Instructions:</strong> {{medicine.instructions}}<br>
                    <strong>Time:</strong> {{medicine.timing || medicine.time}}
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Additional Notes -->
          <div *ngIf="currentPrescriptionData.additionalNotes" class="additional-notes mt-4 p-3 bg-light rounded">
            <h5>Additional Notes:</h5>
            <p>{{currentPrescriptionData.additionalNotes}}</p>
          </div>
          
          <!-- Footer -->
          <div class="prescription-footer mt-4 pt-3 border-top">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Doctor:</strong> Dr. Rajana P.R., BAMS</p>
                <p><strong>Generated On:</strong> {{ this['today'] | date:'medium' }}</p>
              </div>
              <div class="col-md-6 text-end">
                <div class="signature-line mt-4">
                  <p class="border-top d-inline-block pt-2" style="width: 200px; text-align: center;">
                    Doctor's Signature
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- No Prescription Message -->
        <div *ngIf="!currentPrescriptionData" class="text-center py-5">
          <i class="fas fa-file-prescription fa-5x text-muted mb-3"></i>
          <h5 class="text-muted">No Prescription Available</h5>
          <p class="text-muted">This shipment does not have any prescription attached.</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        
        <!-- Print buttons for multiple prescriptions -->
        <div *ngIf="currentPrescriptionData" class="btn-group">
          <button type="button" class="btn btn-info" (click)="printPrescriptionPDF()">
            <i class="fas fa-print"></i> Print Current
          </button>
          
          <button type="button" 
                  class="btn btn-primary" 
                  (click)="printAllPrescriptions()"
                  *ngIf="hasMultiplePrescriptions()">
            <i class="fas fa-print"></i> Print All ({{ allPrescriptions.length }})
          </button>
        </div>
        

      </div>
    </div>
  </div>
</div>


<!-- Updated Invoice Modal with separate print layout -->
<!-- src/app/shipments/shipments.component.html -->

<!-- Find the #invoiceModal element and replace its content -->
<div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="invoiceModalLabel">Invoice #{{ invoiceData.invoiceNo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invoicePrintContent">
        <!-- Invoice Header and Customer Details -->
        <div class="invoice-print-header">
          <img src="assets/logo2.png" alt="Company Logo" class="logo">
          <div class="company-details">
            <h3>HERBALY TOUCH AYURVEDA PRODUCTS PRIVATE LIMITED</h3>
            <p>1st Floor, Chirackal Tower, Ayroor P.O, Emakulam, Kerala, 683579, India</p>
            <p>Mobile: 00917034110999 | GST: 32AAGCH3136H12X</p>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Invoice No:</strong> {{ invoiceData.invoiceNo }}</p>
            <p><strong>Date:</strong> {{ invoiceData.date }}</p>
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Customer:</strong> {{ invoiceData.to.name }}</p>
            <p>{{ invoiceData.to.address }}</p>
            <p>Mobile: {{ invoiceData.to.mobile }}</p>
          </div>
        </div>

        <!-- Products Table with Dynamic Columns -->
        <div class="table-responsive mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Price (₹)</th>
                <th>Discount</th>
                <th>Taxable Value (₹)</th>
                
                <!-- ======================= CONDITIONAL HEADERS (THE FIX) ======================= -->
                <th *ngIf="invoiceHasCgstSgst">CGST (₹)</th>
                <th *ngIf="invoiceHasCgstSgst">SGST (₹)</th>
                <th *ngIf="invoiceHasIgst">IGST (₹)</th>
                <!-- ===================== END OF CONDITIONAL HEADERS ==================== -->
                
                <th>Subtotal (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of invoiceData.products; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.quantity }} Nos.</td>
                <td class="text-end">{{ product.unitPrice | number:'1.2-2' }}</td>
                <td class="text-end">{{ product.discount | number:'1.2-2' }}</td>
                <td class="text-end">{{ product.taxableValue | number:'1.2-2' }}</td>

                <!-- ======================= CONDITIONAL DATA CELLS (THE FIX) ======================= -->
                <td *ngIf="invoiceHasCgstSgst" class="text-end">{{ product.cgstAmount | number:'1.2-2' }} ({{ product.cgstRate | number:'1.2-2' }}%)</td>
                <td *ngIf="invoiceHasCgstSgst" class="text-end">{{ product.sgstAmount | number:'1.2-2' }} ({{ product.sgstRate | number:'1.2-2' }}%)</td>
                <td *ngIf="invoiceHasIgst" class="text-end">{{ product.igstAmount | number:'1.2-2' }} ({{ product.igstRate | number:'1.2-2' }}%)</td>
                <!-- ===================== END OF CONDITIONAL DATA CELLS ==================== -->

                <td class="text-end">{{ product.subtotal | number:'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totals Section -->
        <div class="row mb-4">
          <div class="col-md-6">
            <!-- This column is intentionally empty for alignment -->
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Total Taxable Value: </strong> <strong>₹{{ invoiceData.totalTaxableValue | number:'1.2-2' }}</strong></p>
            
            <!-- ======================= CONDITIONAL TOTALS (THE FIX) ======================= -->
            <p *ngIf="invoiceHasCgstSgst"><strong>Total CGST: </strong> <strong>₹{{ getTotalCGST() | number:'1.2-2' }}</strong></p>
            <p *ngIf="invoiceHasCgstSgst"><strong>Total SGST: </strong> <strong>₹{{ getTotalSGST() | number:'1.2-2' }}</strong></p>
            <p *ngIf="invoiceHasIgst"><strong>Total IGST: </strong> <strong>₹{{ getTotalIGST() | number:'1.2-2' }}</strong></p>
            <!-- ===================== END OF CONDITIONAL TOTALS ==================== -->
            
            <p><strong>Grand Total: </strong> <strong>₹{{ getGrandTotal() | number:'1.0-0' }}</strong></p>
          </div>
        </div>

        <!-- Payment Info and Footer -->
        <div class="row">
          <div class="col-12">
            <p><strong>Payment Method:</strong> {{ selectedShipment?.paymentMethod || 'N/A' }}</p>
            <p><strong>Amount Paid:</strong> ₹{{ selectedShipment?.paymentAmount | number:'1.2-2' }}</p>
            <p><strong>Balance Due:</strong> ₹{{ selectedShipment?.balance | number:'1.2-2' }}</p>
          </div>
        </div>
        <div class="text-center mt-4">
          <p>Thank you for your business!</p>
          <small class="text-muted">This is a computer generated invoice and does not require signature</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="printGeneratedInvoice()">
          <i class="fa fa-print"></i> Print Invoice
        </button>
      </div>
    </div>
  </div>
</div>






</div>
<!-- Bulk Status Update Modal -->
<div class="modal fade" id="bulkStatusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Shipping Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Status</label>
       <select class="form-select" [(ngModel)]="bulkStatusUpdate.status">
  <option value="Processing">Processing</option>
  <option value="Packed">Packed</option>
  <option value="Pending">Pending</option>
  <option value="Shipped">Shipped</option>
  <option value="Onhold">Onhold</option>
  <option value="Ordered">Ordered</option>
  <option value="Print">Print</option>
  <option value="Reached hub">Reached hub</option>
  <option value="Out for delivery">Out for delivery</option>
  <option value="Returned">Returned</option>
  <option value="Cancelled">Cancelled</option>
  <option value="Delivered">Delivered</option>
</select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateBulkStatus()" [disabled]="isUpdating">
          <span *ngIf="isUpdating" class="spinner-border spinner-border-sm"></span>
          Update Status
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="filterModal" tabindex="-1" *ngIf="showFilters">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Filter Shipments</h5>
        <button type="button" class="btn-close" (click)="toggleFilters()"></button>
      </div>
   
        
    
        
        <div class="mb-3">
          <label class="form-label">Date Range</label>
          <input type="text" class="form-control" [(ngModel)]="filterValues.dateRange">
        </div>
        
        <div class="mb-3">
          <label class="form-label">User</label>
          <select class="form-select" [(ngModel)]="filterValues.user">
            <option value="All">All Users</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Payment Status</label>
          <select class="form-select" [(ngModel)]="filterValues.paymentStatus">
            <option value="All">All</option>
            <option value="Paid">Paid</option>
            <option value="Partial">Partial</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Shipping Status</label>
          <select class="form-select" [(ngModel)]="filterValues.shippingStatus">
  <option value="All">All</option>
  <option value="Processing">Processing</option>
  <option value="Packed">Packed</option>
  <option value="Pending">Pending</option>
  <option value="Shipped">Shipped</option>
  <option value="Onhold">Onhold</option>
  <option value="Ordered">Ordered</option>
  <option value="Print">Print</option>
  <option value="Reached hub">Reached hub</option>
  <option value="Out for delivery">Out for delivery</option>
  <option value="Returned">Returned</option>
  <option value="Cancelled">Cancelled</option>
  <option value="Delivered">Delivered</option>
</select>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Delivery Person</label>
          <select class="form-select" [(ngModel)]="filterValues.deliveryPerson">
            <option value="All">All</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="resetFilters()">Reset</button>
        <button type="button" class="btn btn-primary" (click)="applyFilters()">Apply</button>
      </div>
    </div>
  </div>


<!-- Payment Status Edit Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Payment Status</h5>
        <button type="button" class="close" (click)="cancelEdit()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Payment Status</label>
          <select class="form-control" [(ngModel)]="editData.paymentStatus">
            <option value="Paid">Paid</option>
            <option value="Partial">Partial</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>
        <div class="form-group mt-3" *ngIf="editData.paymentStatus === 'Partial'">
          <label>Partial Amount</label>
          <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="editData.partialAmount" 
          [max]="currentShipment?.totalPayable ?? null" 
          min="0">
        
        </div>
  
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="savePaymentStatus()" [disabled]="isSaving">
          <span *ngIf="!isSaving">Save</span>
          <span *ngIf="isSaving">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Saving...
          </span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Activities Section -->

</div>

<div class="modal-backdrop fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'"></div>
<!-- Edit Shipment Modal -->
<!-- Update the edit modal in your template -->
<div class="modal fade" [class.show]="showEditFormModal" [style.display]="showEditFormModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Shipment Details</h5>
        <button type="button" class="close" (click)="closeEditFormModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form #editForm="ngForm">
          <div class="row">
           
            <!-- <div class="col-md-6">
              <div class="form-group">
                <label>Date</label>
                <input type="date" class="form-control" [(ngModel)]="editFormData.date" name="date" required>
              </div>
            </div> -->
          </div>
          
          <div class="row">
           
            
         
      
          <!-- Add new fields here -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Shipping Address</label>
                <input type="text" class="form-control" [(ngModel)]="editFormData.billingAddress" name="billingAddress">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Shipping Details</label>
                <textarea class="form-control" [(ngModel)]="editFormData.shippingDetails" name="shippingDetails" rows="2"></textarea>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Shipping Status</label>
<select class="form-control" [(ngModel)]="editFormData.shippingStatus" name="shippingStatus">
  <option value="Processing">Processing</option>
  <option value="Packed">Packed</option>
  <option value="Pending">Pending</option>
  <option value="Shipped">Shipped</option>
  <option value="Delivered">Delivered</option>
  <option value="Onhold">Onhold</option>
  <option value="Ordered">Ordered</option>
  <option value="Print">Print</option>
  <option value="Reached hub">Reached hub</option>
  <option value="Out for delivery">Out for delivery</option>
  <option value="Returned">Returned</option>
  <option value="Cancelled">Cancelled</option>
</select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Shipping Charge</label>
                <input type="number" class="form-control" [(ngModel)]="editFormData.shippingCharge" name="shippingCharge" min="0" step="0.01">
              </div>
            </div>
          </div>
          <!-- Add this near the top of your edit form -->
<div class="form-group">
  <label>Combined Address:</label>
  <textarea [(ngModel)]="combinedAddress" name="combinedAddress" 
            class="form-control" rows="3" readonly></textarea>
  <small class="text-muted">This is the complete formatted address including customer name</small>
</div>
           </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Delivery Person</label>
                <input type="text" class="form-control" 
                       [(ngModel)]="editFormData.deliveryPerson" 
                       name="deliveryPerson"
                       placeholder="Enter delivery person name">
              </div>
            </div>
          
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label>Shipping Notes</label>
                <textarea class="form-control" [(ngModel)]="editFormData.shippingNotes" name="shippingNotes" rows="2"></textarea>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label>Shipping Document</label>
                <input type="file" class="form-control" (change)="handleShippingDocument($event)" name="shippingDocument">
              </div>
            </div>
          </div>
          
          <!-- Activity Section -->
          <div class="row mt-3">
            <div class="col-md-12">
              <h5>Add Activity</h5>
              <div class="form-group">
                <label>Note</label>
                <textarea class="form-control" [(ngModel)]="newActivity.note" name="activityNote" rows="2"></textarea>
              </div>
              <button type="button" class="btn btn-primary btn-sm mt-2" (click)="addActivity()">
                Add Activity
              </button>
            </div>
          </div>
          <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditFormModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveEditedShipment()" [disabled]="isSavingForm">
          <span *ngIf="!isSavingForm">Save Changes</span>
          <span *ngIf="isSavingForm">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Saving...
          </span>
        </button>
      </div>
<!-- In your template -->
<div class="activity-log">
  <div *ngFor="let activity of editFormData.activities" class="activity-item mb-2 p-2 border rounded">
    <div class="d-flex justify-content-between">
      <strong>{{activity.userName || 'System'}}</strong>
      <small class="text-muted">{{activity.timestamp | date:'medium'}}</small>
    </div>
    <div>
      <span *ngIf="activity.fromStatus || activity.toStatus">
        Changed status from 
        <span class="badge" [ngClass]="getStatusBadgeClass(activity.fromStatus)">{{activity.fromStatus || 'None'}}</span>
        to 
        <span class="badge" [ngClass]="getStatusBadgeClass(activity.toStatus)">{{activity.toStatus}}</span>
      </span>
      <span *ngIf="activity.note">
        <div class="mt-1">
          <small>Note: {{activity.note}}</small>
        </div>
      </span>
    </div>
  </div>
</div>