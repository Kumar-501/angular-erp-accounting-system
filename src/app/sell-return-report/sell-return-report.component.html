<!-- sell-return-report.component.html -->
<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4>Sales Returns Report</h4>
      <div class="input-group" style="width: 300px;">
        <span class="input-group-text"><i class="fa fa-search"></i></span>
        <input type="text" class="form-control" placeholder="Search returns..."
                [(ngModel)]="searchTerm" (keyup)="applyFilters()">
      </div>
    </div>
    
    <div class="card-body">
      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h3>{{ returns.length }}</h3>
              <p class="mb-0">Total Returns</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h3>{{ getProcessedReturnsCount() }}</h3>
              <p class="mb-0">Processed</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body text-center">
              <h3>{{ getPendingReturnsCount() }}</h3>
              <p class="mb-0">Pending</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h3>₹{{ getTotalRefundAmountAll() | number:'1.2-2' }}</h3>
              <p class="mb-0">Total Refunds</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Date Filter -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">From Date:</label>
          <input type="date" class="form-control" [(ngModel)]="fromDate" (change)="applyFilters()">
        </div>
        <div class="col-md-4">
          <label class="form-label">To Date:</label>
          <input type="date" class="form-control" [(ngModel)]="toDate" (change)="applyFilters()">
        </div>
        <div class="col-md-4">
          <label class="form-label">Status:</label>
          <select class="form-control" [(ngModel)]="statusFilter" (change)="applyFilters()">
            <option value="">All Statuses</option>
            <option value="Processed">Processed</option>
            <option value="Pending">Pending</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Return Date</th>
              <th>Invoice No</th>
              <th>Customer</th>
              <th>Returned Items</th>
              <th>Reason</th>
              <th class="text-end">Refund Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ret of filteredReturns | slice: (currentPage-1)*entriesPerPage : currentPage*entriesPerPage; let i = index">
              <td>
                <strong>{{ getReturnDate(ret) | date:'shortDate' }}</strong>
                <br>
              </td>
              <td>
                <span class="badge bg-secondary">{{ ret.invoiceNo || ret.saleData?.invoiceNo || 'N/A' }}</span>
              </td>
              <td>
                <strong>{{ ret.customer || ret.saleData?.customer || 'N/A' }}</strong>
              </td>
              <td>
                <div class="small">
                  <div *ngFor="let item of ret.returnedItems; let first = first" 
                       [class.mb-1]="!first">
                    <span class="badge bg-light text-dark me-1">
                      {{ item.name || item.productName || 'Unknown Item' }}
                    </span>
                    <span class="text-muted">
                      ({{ item.quantity || item.returnQuantity || 0 }} of {{ item.originalQuantity || item.quantity || 0 }})
                    </span>
                  </div>
                </div>
              </td>
              <td>
                <span class="text-muted" [title]="ret.returnReason || ret.reason || 'No reason provided'">
                  {{ (ret.returnReason || ret.reason || 'No reason provided') | slice:0:50 }}
                  <span *ngIf="(ret.returnReason || ret.reason || '').length > 50">...</span>
                </span>
              </td>
              <td class="text-end">
                <strong class="text-success">₹{{ getTotalRefundAmount(ret.returnedItems) | number:'1.2-2' }}</strong>
              </td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-success': getReturnStatus(ret) === 'Processed',
                  'bg-warning text-dark': getReturnStatus(ret) === 'Pending',
                  'bg-danger': getReturnStatus(ret) === 'Rejected',
                  'bg-info': getReturnStatus(ret) === 'Completed'
                }">
                  {{ getReturnStatus(ret) }}
                </span>
              </td>

            </tr>
          </tbody>
        </table>
        
        <div *ngIf="filteredReturns.length === 0" class="text-center py-4">
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            <strong>No returns found</strong>
            <p class="mb-0 mt-2">Try adjusting your search criteria or date filters.</p>
          </div>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="row mt-3" *ngIf="filteredReturns.length > 0">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <span class="me-2">Show:</span>
            <select class="form-select form-select-sm" style="width: auto;" 
                    [(ngModel)]="entriesPerPage" (change)="onEntriesPerPageChange()">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
            <span class="ms-2">entries</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end align-items-center">
            <span class="me-3">
              Showing {{ (currentPage-1)*entriesPerPage + 1 }} to 
              {{ Math.min(currentPage*entriesPerPage, totalEntries) }} 
              of {{ totalEntries }} entries
            </span>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm"
                      [disabled]="currentPage === 1"
                      (click)="previousPage()">
                <i class="fa fa-chevron-left"></i> Previous
              </button>
              <button class="btn btn-outline-secondary btn-sm"
                      [disabled]="currentPage*entriesPerPage >= totalEntries"
                      (click)="nextPage()">
                Next <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Return Details Modal -->
<div class="modal fade" id="returnDetailsModal" tabindex="-1" *ngIf="selectedReturn">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Return Details - {{ selectedReturn.invoiceNo }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Return Date:</strong> {{ getReturnDate(selectedReturn) | date:'medium' }}</p>
            <p><strong>Customer:</strong> {{ selectedReturn.customer || selectedReturn.saleData?.customer }}</p>
            <p><strong>Status:</strong> 
              <span class="badge" [ngClass]="{
                'bg-success': getReturnStatus(selectedReturn) === 'Processed',
                'bg-warning text-dark': getReturnStatus(selectedReturn) === 'Pending',
                'bg-danger': getReturnStatus(selectedReturn) === 'Rejected'
              }">
                {{ getReturnStatus(selectedReturn) }}
              </span>
            </p>
          </div>
          <div class="col-md-6">
            <p><strong>Original Sale Date:</strong> {{ selectedReturn.saleData?.saleDate | date:'mediumDate' }}</p>
            <p><strong>Total Refund:</strong> ₹{{ getTotalRefundAmount(selectedReturn.returnedItems) | number:'1.2-2' }}</p>
          </div>
        </div>
        
        <h6>Return Reason:</h6>
        <p class="bg-light p-2 rounded">{{ selectedReturn.returnReason || selectedReturn.reason || 'No reason provided' }}</p>
        
        <h6>Returned Items:</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Item</th>
                <th>Returned Qty</th>
                <th>Unit Price</th>
                <th class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedReturn.returnedItems">
                <td>{{ item.name || item.productName }}</td>
                <td>{{ item.quantity || item.returnQuantity }}</td>
                <td>₹{{ item.unitPrice || item.price | number:'1.2-2' }}</td>
                <td class="text-end">₹{{ item.subtotal || (item.unitPrice * item.quantity) | number:'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="printReturn(selectedReturn)">
          <i class="fa fa-print"></i> Print Receipt
        </button>
      </div>
    </div>
  </div>
</div>