<div class="order-view-container">
  <div class="header">
    <h2>Purchase Order Details</h2>
    <div class="action-buttons">
      <button routerLink="/purchase-order" class="back-button">
        <i class="fa fa-arrow-left"></i> Back to List
      </button>

      <button (click)="downloadPDF()" class="download-button">
        <i class="fa fa-download"></i> Download PDF
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    Loading order details...
  </div>
  
  <div *ngIf="error" class="error alert alert-danger">{{ error }}</div>

  <div *ngIf="order && !isLoading" class="order-details">
    <div class="detail-section basic-info">
      <h3>Basic Information</h3>
      <div class="detail-grid">
        <div class="detail-row">
          <span class="detail-label">Reference No:</span>
          <span class="detail-value">{{ order.referenceNo || 'N/A' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value">{{ (order.createdAt?.toDate() | date:'mediumDate') || (order.date | date:'mediumDate') || 'N/A' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Business Location:</span>
          <span class="detail-value">{{ order.businessLocation || order.locationName || 'N/A' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Supplier:</span>
          <span class="detail-value">{{ order.supplierName || order.supplier || 'N/A' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value status-badge" [ngClass]="{
            'status-pending': order.status === 'Pending',
            'status-processing': order.status === 'Processing',
            'status-shipped': order.status === 'Shipped',
            'status-delivered': order.status === 'Delivered',
            'status-cancelled': order.status === 'Cancelled'
          }">
            {{ order.status || 'N/A' }}
          </span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Shipping Status:</span>
          <span class="detail-value status-badge" [ngClass]="{
            'status-pending': order.shippingStatus === 'Pending',
            'status-processing': order.shippingStatus === 'Processing',
            'status-shipped': order.shippingStatus === 'Shipped',
            'status-delivered': order.shippingStatus === 'Delivered',
            'status-cancelled': order.shippingStatus === 'Cancelled'
          }">
            {{ order.shippingStatus || 'Not specified' }}
          </span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Required By Date:</span>
          <span class="detail-value">{{ order.requiredByDate || order.requiredDate || order.required_date || 'N/A' | date:'mediumDate' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Added By:</span>
          <span class="detail-value">{{ order.addedBy || 'N/A' }}</span>
        </div>

        <div class="detail-row" *ngIf="order.brand">
          <span class="detail-label">Brand:</span>
          <span class="detail-value">{{ order.brand }}</span>
        </div>

        <div class="detail-row" *ngIf="order.category">
          <span class="detail-label">Category:</span>
          <span class="detail-value">{{ order.category }}</span>
        </div>
      </div>
    </div>

    <div class="detail-section" *ngIf="(order.products && order.products.length > 0) || (order.items && order.items.length > 0)">
      <h3>Products</h3>
      <div class="table-responsive">
        <table class="products-table">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Product Name</th>
              <th>SKU</th>
              <th>HSN Code</th>
              <th>Tax Rate</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Current Stock</th>
              <th>Alert Qty</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of (order.items || order.products || []); let i = index">
              <td>{{ i + 1 }}</td>
              <td>
                {{ item.productName || getProductDetails(item.productId).productName }}
                <div *ngIf="item.batchNumber" class="batch-info">
                  <strong>Batch:</strong> {{ item.batchNumber }}
                </div>
                <div *ngIf="item.expiryDate" class="expiry-info">
                  <strong>Expiry:</strong> {{ item.expiryDate | date:'mediumDate' }}
                </div>
              </td>
              <td>{{ getProductDetails(item.productId).sku || 'N/A' }}</td>
              <td>{{ getProductDetails(item.productId).hsnCode || 'N/A' }}</td>
              <td>{{ getProductDetails(item.productId).taxPercentage|| 'N/A' }}</td>
              <td>{{ item.quantity || item.requiredQuantity || 0 }}</td>
              <td>{{ (item.unitCost || item.unitPurchasePrice || getProductDetails(item.productId).defaultPurchasePrice || 0) | currency:'INR' }}</td>
              <!-- Fixed: Safe navigation with proper null checks -->
              <td [class.low-stock]="(getProductDetails(item.productId).currentStock || 0) <= (getProductDetails(item.productId).alertQuantity || 0)">
                {{ getProductDetails(item.productId).currentStock || 0 }}
              </td>
              <td>{{ getProductDetails(item.productId).alertQuantity || 0 }}</td>
              <td>{{ calculateLineTotal(item) | currency:'INR' }}</td>
            </tr>
            <tr class="total-row">
              <td colspan="9" class="text-right"><strong>Total:</strong></td>
              <td><strong>{{ getTotalAmount() | currency:'INR' }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="detail-section" *ngIf="order.shippingDetails?.shippingAddress || order.shippingDetails?.deliveredTo">
      <h3>Shipping Information</h3>
      <div class="shipping-info">
        <div class="detail-row" *ngIf="order.shippingDetails?.shippingAddress">
          <span class="detail-label">Shipping Address:</span>
          <span class="detail-value">{{ order.shippingDetails.shippingAddress }}</span>
        </div>
        <div class="detail-row" *ngIf="order.shippingDetails?.deliveredTo">
          <span class="detail-label">Delivered To:</span>
          <span class="detail-value">{{ order.shippingDetails.deliveredTo }}</span>
        </div>
        <div class="detail-row" *ngIf="order.shippingDetails?.deliveryPerson">
          <span class="detail-label">Delivery Person:</span>
          <span class="detail-value">{{ order.shippingDetails.deliveryPerson }}</span>
        </div>
        <div class="detail-row" *ngIf="order.shippingDetails?.shippingCharges">
          <span class="detail-label">Shipping Charges:</span>
          <span class="detail-value">{{ order.shippingDetails.shippingCharges | currency:'INR' }}</span>
        </div>
      </div>
    </div>

    <div class="detail-section" *ngIf="order.additionalNotes || order.shippingDetails?.note">
      <h3>Additional Notes</h3>
      <div class="notes-content">
        <p>{{ order.additionalNotes || order.shippingDetails?.note || 'No additional notes' }}</p>
      </div>
    </div>
  </div>
</div>