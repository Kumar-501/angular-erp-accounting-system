<div class="stock-transfers-container">
  <h1>Add Stock Adjustment</h1>
  
  <div class="content-panel">
    <form [formGroup]="adjustmentForm" (ngSubmit)="saveAdjustment()">
      <!-- Form Header Section -->
      <div class="form-header-grid">
        <div class="col-md-6">
          <div class="form-group">
            <label>Business Location:</label>
            <select formControlName="businessLocation" class="form-control" required>
              <option value="">Select Business Location</option>
              <option *ngFor="let location of businessLocations" [value]="location.id">
                {{ location.name }} ({{ location.locationId || 'BL000' + (businessLocations.indexOf(location) + 1) }})
              </option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="referenceNo">Reference No:</label>
          <input id="referenceNo" type="text" formControlName="referenceNo" class="form-control">
        </div>
        
<div class="form-group">
  <label for="date">Date:<span class="required">*</span></label>
  <div class="date-input-wrapper">
    <input type="text" 
           class="form-control date-input" 
           [value]="getFormattedDateForInput(adjustmentForm.get('date')?.value)"
           (blur)="onManualDateInput($event, 'date')"
           placeholder="DD-MM-YYYY">
    
    <button type="button" class="calendar-btn" (click)="openDatePicker()">
      <i class="fa fa-calendar"></i>
    </button>
    
    <!-- Hidden native picker -->
    <input #datePicker 
           type="date" 
           formControlName="date" 
           class="hidden-date-picker">
  </div>
  
  <div class="error-message" *ngIf="submitted && f['date'].errors">
    Date is required
  </div>
</div>
        
        <div class="form-group">
          <label for="adjustmentType">Adjustment type:<span class="required">*</span>
            <i class="fa fa-question-circle info-icon" title="Type of adjustment: Addition or Deduction"></i>
          </label>
          <select id="adjustmentType" formControlName="adjustmentType" class="form-control">
            <option value="">Please Select</option>
            <option value="addition">Addition</option>
            <option value="deduction">Deduction</option>
          </select>
          <div class="error-message" *ngIf="submitted && f['adjustmentType'].errors">
            Adjustment type is required
          </div>
        </div>
      </div>
      
      <!-- Products Section -->
      <div class="products-section">
        <div class="search-container">
          
          
          <div class="table-container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody formArrayName="products">
                <tr *ngFor="let product of products.controls; let i = index" [formGroupName]="i">
                  <td>
                    <!-- Improved Product Dropdown -->
                    <div class="product-dropdown-container position-relative">
                      <input 
                        type="text" 
                        class="form-control product-search-input" 
                        formControlName="name" 
                        placeholder="Select or search product" 
                        (focus)="onProductInputFocus(i)"
                        (blur)="onProductInputBlur(i)"
                        (input)="onProductInputChange($event, i)"
                        autocomplete="off">
                      
                      <!-- Custom Dropdown with proper null checks -->
                      <div class="product-dropdown" 
                           [class.show]="isDropdownVisible(i)">
                        <div class="dropdown-item" 
                             *ngFor="let prod of getFilteredProductsForRow(i)" 
                             (mousedown)="selectProduct(prod, i)">
                          <div class="product-item">
                            <div class="product-name">{{ prod?.productName || 'Unknown Product' }}</div>
                            <div class="product-details">
                              <span class="sku">SKU: {{ prod?.sku || 'N/A' }}</span>
                              <span class="price">₹{{ prod?.defaultSellingPriceExcTax || 0 }}</span>
                            </div>
                          </div>
                        </div>
                        
                        <!-- No products found message -->
                        <div class="dropdown-item no-products" 
                             *ngIf="getFilteredProductsForRow(i).length === 0 && isDropdownVisible(i)">
                          <div class="product-item">
                            <div class="product-name text-muted">No products found</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div *ngIf="submitted && product.get('name')?.errors" class="text-danger mt-1">
                      Product name is required
                    </div>
                  </td>
                  
                  <td>
                    <input type="number" 
                           formControlName="quantity" 
                           (input)="updateSubtotal(i)" 
                           min="1" 
                           placeholder="0"
                           class="form-control">
                  </td>
                  
                  <td>
                    <input type="number" 
                           formControlName="unitPrice" 
                           (input)="updateSubtotal(i)" 
                           min="0" 
                           step="0.01" 
                           placeholder="0.00"
                           class="form-control">
                  </td>
                  
                  <td>
                    <input type="text" 
                           [value]="(product.get('subtotal')?.value || 0) | number:'1.2-2'" 
                           readonly
                           class="form-control">
                  </td>
                  
                  <td class="actions-column">
                    <button type="button" 
                            class="btn btn-danger btn-sm" 
                            (click)="removeProduct(i)">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
                
                <tr *ngIf="products.controls.length === 0">
                  <td colspan="5" class="no-data text-center">No products added</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="total-section">
            <div class="total-label">Total Amount:</div>
            <div class="total-amount">₹{{ totalAmount | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>
      
      <!-- Additional Details Section -->
      <div class="additional-details">
        <div class="form-row">
          <div class="form-group">
            <label for="totalAmountRecovered">
              Total amount recovered:
              <i class="fa fa-question-circle info-icon" title="Amount recovered for deducted stock"></i>
            </label>
            <input id="totalAmountRecovered" 
                   type="number" 
                   formControlName="totalAmountRecovered" 
                   class="form-control">
          </div>
          
          <div class="form-group reason-group">
            <label for="reason">Reason:</label>
            <textarea id="reason" 
                      formControlName="reason" 
                      class="form-control" 
                      rows="4"></textarea>
          </div>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" 
                class="btn btn-primary" 
                [disabled]="isSaving || adjustmentForm.invalid">
          <span *ngIf="!isSaving">Save Adjustment</span>
          <span *ngIf="isSaving">
            <i class="fa fa-spinner fa-spin"></i> Saving...
          </span>
        </button>
        
        <button type="button" 
                class="btn btn-secondary" 
                (click)="router.navigate(['/list-adjustment'])">
          Go to List
        </button>
      </div>
    </form>
  </div>
</div>