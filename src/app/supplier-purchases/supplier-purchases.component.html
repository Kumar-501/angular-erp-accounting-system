<div class="container-fluid p-3"> 
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-secondary mb-0">Supplier Profile</h4>
    <button class="btn btn-success" (click)="openPaymentModal()">
      <i class="fas fa-hand-holding-usd me-2"></i>Pay Cash / Add Payment
    </button>
  </div>
  <app-account-summary [accountData]="accountSummaryData"></app-account-summary>
  
  <!-- Supplier Details Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #3d82bb;">
      <h4 class="mb-0">Supplier Details</h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="fw-bold text-secondary">Business Name:</label>
            <p class="mb-1">{{ supplierDetails.businessName || 'N/A' }}</p>
          </div>
          <div class="mb-3">
            <label class="fw-bold text-secondary">Contact Name:</label>
            <p class="mb-1">{{ supplierDetails.firstName }} {{ supplierDetails.lastName }}</p>
          </div>
          <div class="mb-3">
            <label class="fw-bold text-secondary">Mobile:</label>
            <p class="mb-1">{{ supplierDetails.mobile || 'N/A' }}</p>
          </div>
          <div class="mb-3">
            <label class="fw-bold text-secondary">Alternate Contact:</label>
            <p class="mb-1">{{ supplierDetails.alternateContact || 'N/A' }}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="fw-bold text-secondary">Address:</label>
            <p class="mb-1">
              {{ supplierDetails.addressLine1 }}<br>
              {{ supplierDetails.addressLine2 }}<br>
              {{ supplierDetails.city }}, {{ supplierDetails.state }}<br>
              {{ supplierDetails.country }} - {{ supplierDetails.zipCode }}
            </p>
          </div>
          <div class="mb-3">
            <label class="fw-bold text-secondary">Tax Number:</label>
            <p class="mb-1">{{ supplierDetails.taxNumber || 'N/A' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Tab Navigation -->
  <div *ngIf="activeTab === 'purchases'">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div class="btn-group" role="group" style="height: 41px;">
          <button class="btn btn-sm" 
                  [ngClass]="{'btn-primary': viewMode === 'purchases', 'btn-outline-primary': viewMode !== 'purchases'}"
                  (click)="viewMode = 'purchases'">
            <i class="fas fa-shopping-cart me-1"></i> Purchases
          </button>
          <button class="btn btn-sm" 
                  [ngClass]="{'btn-primary': viewMode === 'ledger', 'btn-outline-primary': viewMode !== 'ledger'}"
                  (click)="viewMode = 'ledger'; updateLedgerView()">
            <i class="fas fa-book me-1"></i> Ledger View
          </button>
          <button class="btn btn-sm" 
                  [ngClass]="{'btn-primary': viewMode === 'payments', 'btn-outline-primary': viewMode !== 'payments'}"
                  (click)="viewMode = 'payments'; loadPayments()">
            <i class="fas fa-money-bill-wave me-1"></i> Payments
          </button>
          <!-- New Documents Button -->
          <button class="btn btn-sm" 
                  [ngClass]="{'btn-primary': viewMode === 'documents', 'btn-outline-primary': viewMode !== 'documents'}"
                  (click)="viewMode = 'documents'">
            <i class="fas fa-folder-open me-1"></i> Documents & Notes
          </button>
        </div>
      </div>

      <!-- Purchases View -->
      <div *ngIf="viewMode === 'purchases'" class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Reference</th>
              <th style="width: 30%;">Product Details</th>
              <th>Payment Method</th>
              <th class="text-end">Total Amount</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let purchase of filteredPurchases">
              <td>{{ purchase.purchaseDate | date:'mediumDate' }}</td>
              <td><span class="fw-bold text-primary">{{ purchase.referenceNo || 'N/A' }}</span></td>
              <td>
                <div *ngIf="purchase.products && purchase.products.length > 0">
                  <div *ngFor="let item of purchase.products" class="d-flex justify-content-between small text-muted border-bottom mb-1 pb-1">
                    <span>{{ item.productName }}</span>
                    <span class="fw-bold">x{{ item.quantity }}</span>
                  </div>
                </div>
                <small *ngIf="!purchase.products || purchase.products.length === 0" class="text-muted">
                  No items listed
                </small>
              </td>
              <td>
                <span class="badge bg-light text-dark border">
                  {{ purchase.paymentMethod || 'Credit/Pending' }}
                </span>
              </td>
              <td class="text-end fw-bold">₹ {{ getSafeGrandTotal(purchase).toFixed(2) }}</td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(purchase.purchaseStatus)">
                  {{ purchase.purchaseStatus }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary" (click)="viewPurchaseDetails(purchase)">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredPurchases.length === 0">
              <td colspan="7" class="text-center py-4 text-muted">No purchases found.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Ledger View -->
      <div *ngIf="viewMode === 'ledger'" class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Reference No</th>
                <th>Supplier</th>
                <th>Description</th>
                <th class="text-end">Credit (₹)</th>
                <th class="text-end">Debit (₹)</th>
                <th class="text-end">Balance (₹)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of ledgerEntries" 
                  [class.clickable]="entry.purchase || entry.payment"
                  (click)="entry.purchase ? viewPurchaseDetails(entry.purchase) : viewPaymentDetails(entry.payment?.id)">
                <td>{{ entry.date | date:'mediumDate' }}</td>
                <td>{{ entry.referenceNo }}</td>
                <td>{{ entry.supplier }}</td>
                <td>{{ entry.description }}</td>
                <td class="text-end text-success">{{ entry.type === 'credit' ? (entry.amount | currency:'INR':'symbol':'1.2-2') : '-' }}</td>
                <td class="text-end text-danger">{{ entry.type === 'debit' ? (entry.amount | currency:'INR':'symbol':'1.2-2') : '-' }}</td>
                <td class="text-end" [ngClass]="{'text-danger': entry.balance < 0, 'text-success': entry.balance >= 0}">
                  {{ entry.balance | currency:'INR':'symbol':'1.2-2' }}
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusClass(entry.status)">
                    {{ entry.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

<!-- Payments View - UPDATED -->
<div *ngIf="viewMode === 'payments'" class="card-body p-0">
  <div *ngIf="paymentLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading payments...</p>
  </div>

  <div *ngIf="!paymentLoading && payments.length === 0" class="text-center py-5">
    <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
    <p class="text-muted">No payments found for this supplier</p>
  </div>

  <div *ngIf="!paymentLoading && payments.length > 0" class="table-responsive">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Reference</th>
          <th>Payment Method</th>
          <th class="text-end">Amount</th>
          <th>Notes</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let payment of payments">
          <td>
            <span class="fw-bold">{{ payment.paymentDate | date:'dd/MM/yyyy' }}</span>
            <div class="small text-muted">{{ payment.paymentDate | date:'shortTime' }}</div>
          </td>
          <td>
            <span class="fw-bold">{{ payment.referenceNo || 'N/A' }}</span>
            <div *ngIf="payment.purchaseRef" class="small text-muted">For: {{payment.purchaseRef}}</div>
          </td>
          <td>
            <span class="badge bg-info text-dark bg-opacity-25 border border-info">
              {{ payment.paymentMethod || 'Cash' }}
            </span>
          </td>
          <td class="text-end fw-bold text-success">
            {{ payment.amount | currency:'INR':'symbol' }}
          </td>
          <td class="small text-muted" style="max-width: 200px;">
            {{ payment.notes || '-' }}
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary" 
                    (click)="openReceiptModal(payment)"
                    title="View Receipt">
              <i class="fas fa-receipt me-1"></i> View
            </button>
          </td>
        </tr>
      </tbody>
      <tfoot class="table-light">
        <tr>
          <td colspan="3" class="text-end fw-bold">Total Paid:</td>
          <td class="text-end fw-bold">{{ getTotalPaid() | currency:'INR':'symbol' }}</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Documents & Notes View -->
      <div *ngIf="viewMode === 'documents'" class="card-body">
        <div class="row">
          <!-- Notes Section -->
          <div class="col-md-6 mb-4 border-end">
            <h6 class="text-muted border-bottom pb-2 mb-3">Notes</h6>
            
            <!-- Add New Note -->
            <div class="card mb-3 bg-light border-0">
              <div class="card-body p-3">
                <div class="mb-2">
                  <input type="text" class="form-control form-control-sm mb-2" [(ngModel)]="newNote.title" placeholder="Note Title">
                  <textarea class="form-control form-control-sm mb-2" [(ngModel)]="newNote.content" rows="2" placeholder="Note Content"></textarea>
                </div>
                <div class="d-flex justify-content-end align-items-center">
                  <!-- Removed "Private" Checkbox -->
                  <button class="btn btn-sm btn-primary" (click)="addNote()">
                    <i class="fas fa-plus me-1"></i> Add
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Notes List -->
            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
              <div class="list-group-item px-0" *ngFor="let note of notes">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">{{note.title}}</h6>
                    <small class="text-muted d-block mb-1">{{note.content}}</small>
                    <small class="text-muted" style="font-size: 0.75rem;">
                      {{note.createdAt | date:'short'}} by {{note.createdBy}}
                    </small>
                  </div>
                  <button class="btn btn-sm text-danger" (click)="deleteNote(note.id || '')">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
              <div *ngIf="notes.length === 0" class="text-center py-3 text-muted">
                <small>No notes available</small>
              </div>
            </div>
          </div>
          
          <!-- Documents Section -->
          <div class="col-md-6 mb-4">
            <h6 class="text-muted border-bottom pb-2 mb-3">Documents</h6>
            
            <!-- Upload Area -->
            <div class="mb-3">
              <div class="input-group input-group-sm mb-2">
                <input type="file" class="form-control" (change)="onFileSelected($event)" multiple>
                <button class="btn btn-outline-secondary" type="button" (click)="uploadDocuments()" 
                        [disabled]="isUploading || selectedFiles.length === 0">
                  <span *ngIf="isUploading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  <span *ngIf="!isUploading">Upload</span>
                </button>
              </div>
              <!-- Removed "Mark as Private" Checkbox -->
              
              <div *ngIf="uploadProgress !== null" class="progress mt-2" style="height: 5px;">
                <div class="progress-bar bg-success" [style.width]="uploadProgress + '%'"></div>
              </div>
            </div>

            <!-- Documents List -->
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <!-- <th>Date</th> -->
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let doc of documents">
                    <td>
                      <i class="fas fa-file-alt text-secondary me-2"></i>
                      {{doc.name}}
                    </td>
                    <!-- <td class="small text-muted">{{doc.uploadedAt | date:'shortDate'}}</td> -->
                    <td class="text-end">
                      <!-- Changed View (Eye) to Download -->
                      <button class="btn btn-link btn-sm p-0 me-2 text-primary" (click)="downloadDocument(doc)" title="Download">
                        <i class="fas fa-download"></i>
                      </button>
                      <button class="btn btn-link btn-sm p-0 text-danger" (click)="deleteDocument(doc.id || '')" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="documents.length === 0">
                    <td colspan="3" class="text-center py-3 text-muted">
                      <small>No documents uploaded</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
<div class="modal fade" [ngClass]="{'show': showReceiptModal}" [style.display]="showReceiptModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title" style="color: #3d82bb;">
          <i class="fas fa-receipt me-2"></i>Payment Receipt
        </h5>
        <button type="button" class="btn-close" (click)="closeReceiptModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="selectedPayment">
        
        <!-- Receipt Header -->
        <div class="text-center mb-4">
          <h3 class="text-success fw-bold">{{ selectedPayment.amount | currency:'INR':'symbol' }}</h3>
          <p class="text-muted mb-0">Payment Successful</p>
          <small class="text-muted">{{ selectedPayment.paymentDate | date:'medium' }}</small>
        </div>

        <!-- Receipt Details -->
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Reference No</span>
            <span class="fw-bold">{{ selectedPayment.referenceNo || 'N/A' }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Payment Method</span>
            <span class="badge bg-info text-dark">{{ selectedPayment.paymentMethod || 'Cash' }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Paid To</span>
            <span class="fw-bold">{{ supplierDetails.businessName || supplierDetails.firstName }}</span>
          </div>
          <div class="list-group-item" *ngIf="selectedPayment.notes">
            <span class="text-muted d-block mb-1">Notes:</span>
            <div class="p-2 bg-light rounded small">{{ selectedPayment.notes }}</div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeReceiptModal()">Close</button>
        <!-- Updated click handler to call component method -->
 
      </div>
    </div>
  </div>
</div>
<!-- Backdrop for Modal -->
<div class="modal-backdrop fade show" *ngIf="showReceiptModal"></div>
  <!-- Stock Report Tab -->
  <div *ngIf="activeTab === 'stock-report'">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" style="color: #3d82bb;">Stock Purchased from Supplier</h5>
          <div class="input-group input-group-sm" style="max-width: 400px;">
            <span class="input-group-text bg-light"><i class="fas fa-calendar"></i></span>
            <input type="date" class="form-control" [(ngModel)]="stockReportFromDate" (change)="filterStockReport()">
            <span class="input-group-text bg-light">to</span>
            <input type="date" class="form-control" [(ngModel)]="stockReportToDate" (change)="filterStockReport()">
            <button class="btn btn-outline-primary" type="button" (click)="filterStockReport()">Apply</button>
          </div>
        </div>
      </div>
      
      <div class="card-body">
        <!-- Loading State -->
        <div *ngIf="stockReportLoading" class="text-center py-4">
          <div class="spinner-border" role="status" style="color: #3d82bb;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Stock Table -->
        <div *ngIf="!stockReportLoading" class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-light">
              <tr>
                <th class="py-3">Product</th>
                <th class="py-3">SKU</th>
                <th class="py-3">Category</th>
                <th class="py-3">Purchased Qty</th>
                <th class="py-3">Unit</th>
                <th class="py-3">Purchase Price</th>
                <th class="py-3">Total Amount</th>
                <th class="py-3">Last Purchase Date</th>
                <th class="py-3">Current Stock</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of filteredStockReport">
                <td>{{item.productName}}</td>
                <td>{{item.sku}}</td>
                <td>{{item.category}}</td>
                <td>{{item.purchasedQty}}</td>
                <td>{{item.unit}}</td>
                <td>{{item.purchasePrice | currency:'INR':'symbol' }}</td>
                <td>{{item.totalAmount | currency:'INR':'symbol' }}</td>
                <td>{{item.lastPurchaseDate | date}}</td>
                <td>
                  <span [ngClass]="{'text-success': item.currentStock > 20, 'text-warning': item.currentStock <= 20 && item.currentStock > 5, 'text-danger': item.currentStock <= 5}">
                    {{item.currentStock}}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Documents Tab -->
  <div *ngIf="activeTab === 'documents'">
    <div class="container-fluid p-3">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0" style="color: #3d82bb;">Documents & Notes</h5>
        </div>
        
        <div class="card-body">
          <div class="row">
            <!-- Notes Section -->
            <div class="col-md-6 mb-4">
              <!-- Add New Note -->
              <div class="card mb-4 bg-light border-0">
                <div class="card-body">
                  <h6 class="card-title">Add New Note</h6>
                  <div class="mb-3">
                    <label class="form-label">Title*</label>
                    <input type="text" class="form-control" [(ngModel)]="newNote.title" placeholder="Enter note title">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description*</label>
                    <textarea class="form-control" [(ngModel)]="newNote.content" rows="3" placeholder="Enter note content"></textarea>
                  </div>
                  <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" [(ngModel)]="newNote.isPrivate" id="notePrivate">
                    <label class="form-check-label" for="notePrivate">Is Private?</label>
                  </div>
                  <button class="btn w-100" style="background-color: #3d82bb; color: white;" (click)="addNote()">
                    <i class="fas fa-plus me-1"></i> Add Note
                  </button>
                </div>
              </div>
              
              <!-- Notes List -->
              <div *ngIf="notes.length > 0">
                <div class="card mb-3" *ngFor="let note of notes">
                  <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{note.title}}</h6>
                    <div>
                      <span *ngIf="note.isPrivate" class="badge bg-warning me-2">Private</span>
                      <button class="btn btn-sm btn-outline-danger" (click)="deleteNote(note.id || '')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <p>{{note.content}}</p>
                    <hr>
                    <small class="text-muted">
                      <i class="fas fa-user me-1"></i> {{note.createdBy}}
                      <i class="fas fa-clock ms-2 me-1"></i> {{note.createdAt | date:'medium'}}
                    </small>
                  </div>
                </div>
              </div>
              
              <div *ngIf="notes.length === 0" class="text-center py-4">
                <i class="fas fa-sticky-note fa-2x text-muted mb-2"></i>
                <p>No notes found</p>
              </div>
            </div>
            
            <!-- Documents Section -->
            <div class="col-md-6 mb-4">
              <!-- Upload Documents -->
              <div class="card mb-4 bg-light border-0">
                <div class="card-body">
                  <h6 class="card-title">Upload Documents</h6>
                  <div class="mb-3">
                    <input type="file" class="form-control" (change)="onFileSelected($event)" multiple>
                  </div>
                  <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="docPrivate">
                    <label class="form-check-label" for="docPrivate">Is Private?</label>
                  </div>
                  <button class="btn w-100" style="background-color: #3d82bb; color: white;" (click)="uploadDocuments()" [disabled]="isUploading || selectedFiles.length === 0">
                    <span *ngIf="isUploading">
                      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                      Uploading...
                    </span>
                    <span *ngIf="!isUploading">
                      <i class="fas fa-cloud-upload-alt me-1"></i> Upload Documents
                    </span>
                  </button>
                  
                  <div *ngIf="uploadProgress !== null" class="mt-3">
                    <div class="progress">
                      <div class="progress-bar bg-success" [style.width]="uploadProgress + '%'">{{uploadProgress}}%</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Documents List -->
              <div *ngIf="documents.length > 0" class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Document Name</th>
                      <th>Uploaded On</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let doc of documents">
                      <td>{{doc.name}}</td>
                      <td>
                        <small>
                          {{doc.uploadedAt | date:'short'}}
                          <div class="text-muted">by {{doc.uploadedBy}}</div>
                        </small>
                      </td>
                      <td>
                        <span *ngIf="doc.isPrivate" class="badge bg-warning">Private</span>
                        <span *ngIf="!doc.isPrivate" class="badge bg-success">Public</span>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a [href]="doc.url" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i>
                          </a>
                          <button class="btn btn-outline-danger" (click)="deleteDocument(doc.id || '')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div *ngIf="documents.length === 0" class="text-center py-4">
                <i class="fas fa-file fa-2x text-muted mb-2"></i>
                <p>No documents found</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- NEW: Payment Modal -->
<div class="modal fade" [ngClass]="{'show': showPaymentModal}" [style.display]="showPaymentModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-money-bill-wave me-2"></i>Record Payment to {{ supplierDetails.businessName || supplierDetails.firstName }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closePaymentModal()" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        
        <!-- NEW: Summary Cards inside Modal -->
        <div class="row mb-4">
          <div class="col-6">
            <div class="p-2 border rounded bg-light text-center">
              <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Total Paid</small>
              <div class="h5 mb-0 text-success mt-1">{{ accountSummaryData.totalPaid | currency:'INR' }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="p-2 border rounded bg-light text-center">
              <small class="text-uppercase text-muted fw-bold" style="font-size: 0.75rem;">Balance Due</small>
              <div class="h5 mb-0 text-danger mt-1">{{ accountSummaryData.balanceDue | currency:'INR' }}</div>
            </div>
          </div>
        </div>

        <form [formGroup]="paymentForm">
          
          <!-- Amount & Date -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Amount <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input type="number" class="form-control fw-bold" formControlName="amount" placeholder="0.00">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Payment Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" formControlName="paymentDate">
            </div>
          </div>

          <!-- Payment Method & Account -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Payment Method</label>
              <select class="form-select" formControlName="paymentMethod">
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cheque">Cheque</option>
                <option value="UPI">UPI</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Paid From Account <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="paymentAccountId">
                <option [ngValue]="null" disabled>Select Account</option>
                <option *ngFor="let acc of paymentAccounts" [value]="acc.id">
                  {{ acc.name }} (Bal: ₹{{ acc.currentBalance | number:'1.2-2' }})
                </option>
              </select>
            </div>
          </div>

          <!-- Reference & Notes -->
          <div class="mb-3">
            <label class="form-label">Reference No / Transaction ID</label>
            <input type="text" class="form-control" formControlName="referenceNo" placeholder="e.g. CHEQUE-1234">
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" formControlName="notes" rows="2" placeholder="Enter payment remarks..."></textarea>
          </div>

        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePaymentModal()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="submitPayment()" [disabled]="paymentForm.invalid || isSavingPayment">
          <span *ngIf="isSavingPayment" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          {{ isSavingPayment ? 'Processing...' : 'Confirm Payment' }}
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showPaymentModal"></div>
<!-- Enhanced Receipt Modal -->
<div class="modal fade" [ngClass]="{'show': showReceiptModal}" [style.display]="showReceiptModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-receipt me-2"></i>Payment Receipt
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeReceiptModal()" aria-label="Close"></button>
      </div>
      
      <div class="modal-body p-4" *ngIf="selectedPayment">
        
        <!-- Company Header -->
        <div class="text-center border-bottom pb-3 mb-4">
          <h4 class="mb-1">{{ accountSummaryData.companyDetails.name }}</h4>
          <p class="text-muted mb-0 small">{{ accountSummaryData.companyDetails.address }}</p>
        </div>

        <!-- Receipt Header -->
        <div class="text-center mb-4">
          <div class="badge bg-success fs-5 px-4 py-2 mb-2">
            <i class="fas fa-check-circle me-2"></i>PAYMENT RECEIVED
          </div>
          <h2 class="text-success fw-bold mb-1">{{ selectedPayment.amount | currency:'INR':'symbol' }}</h2>
          <p class="text-muted mb-0">
            <i class="fas fa-calendar-alt me-1"></i>
            {{ selectedPayment.paymentDate | date:'fullDate' }}
          </p>
          <small class="text-muted">{{ selectedPayment.paymentDate | date:'shortTime' }}</small>
        </div>

        <!-- Payment Details Card -->
        <div class="card bg-light border-0 mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="text-muted small mb-1">Reference Number</label>
                <div class="fw-bold">{{ selectedPayment.referenceNo || 'N/A' }}</div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small mb-1">Payment Method</label>
                <div>
                  <span class="badge bg-info text-dark">
                    <i class="fas fa-credit-card me-1"></i>{{ selectedPayment.paymentMethod || 'Cash' }}
                  </span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small mb-1">Paid By</label>
                <div class="fw-bold">{{ supplierDetails.businessName || supplierDetails.firstName + ' ' + supplierDetails.lastName }}</div>
              </div>
              <div class="col-md-6">
                <label class="text-muted small mb-1">Account</label>
                <div class="fw-bold">{{ selectedPayment.accountName || 'N/A' }}</div>
              </div>
              <div class="col-12" *ngIf="selectedPayment.purchaseRef">
                <label class="text-muted small mb-1">Related Purchase</label>
                <div class="fw-bold">{{ selectedPayment.purchaseRef }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div *ngIf="selectedPayment.notes" class="mb-4">
          <label class="text-muted small mb-2">
            <i class="fas fa-sticky-note me-1"></i>Notes
          </label>
          <div class="p-3 bg-light rounded border">
            {{ selectedPayment.notes }}
          </div>
        </div>

        <!-- Payment Breakdown -->
        <div class="border-top pt-3">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Payment Amount:</span>
            <span class="fw-bold">{{ selectedPayment.amount | currency:'INR':'symbol' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Payment Status:</span>
            <span class="badge bg-success">Paid</span>
          </div>
          <div class="d-flex justify-content-between border-top pt-2 mt-2">
            <span class="fw-bold fs-5">Total Paid:</span>
            <span class="fw-bold fs-5 text-success">{{ selectedPayment.amount | currency:'INR':'symbol' }}</span>
          </div>
        </div>

        <!-- Footer Note -->
        <div class="text-center mt-4 pt-3 border-top">
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            This is a computer-generated receipt and does not require a signature.
          </small>
        </div>

      </div>
      
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" (click)="closeReceiptModal()">
          <i class="fas fa-times me-1"></i>Close
        </button>
        <button type="button" class="btn btn-primary" onclick="window.print()">
          <i class="fas fa-print me-1"></i>Print Receipt
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop for Modal -->
<div class="modal-backdrop fade show" *ngIf="showReceiptModal"></div>