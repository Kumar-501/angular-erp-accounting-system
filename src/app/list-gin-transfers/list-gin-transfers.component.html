<div class="list-gin-transfers-container">
  <h2>Goods Issue Note</h2>

  <div class="page-header">
    <h3>All GIN Transfers</h3>
    <button class="add-button" routerLink="/add-gin-transfer">
      <i class="fa fa-plus"></i> Add
    </button>
  </div>

  <div class="filters-row">
    <div class="show-entries">
      <label>Show</label>
      <select [(ngModel)]="itemsPerPage" (change)="applyFilters()">
        <option value="15">15</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <label>entries</label>
    </div>

    <div class="export-buttons">
      <button class="export-btn" (click)="exportToExcel()">
        <i class="fa fa-file-excel"></i> Excel
      </button>
      <button class="print-btn" (click)="printTable()">
        <i class="fa fa-print"></i> Print
      </button>
      
      <!-- Custom Column Visibility Dropdown -->
      <div class="custom-dropdown">
        <button class="visibility-btn" type="button" (click)="toggleColumnVisibilityDropdown()">
          <i class="fa fa-eye"></i> Column Visibility
          <i class="fa fa-chevron-down dropdown-arrow" [ngClass]="{'rotated': showColumnVisibilityDropdown}"></i>
        </button>
        
        <div class="custom-dropdown-menu" [ngClass]="{'show': showColumnVisibilityDropdown}" (click)="$event.stopPropagation()">
          <div class="dropdown-item" *ngFor="let col of (columnVisibility | keyvalue)">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [checked]="col.value" 
                (change)="onColumnVisibilityChange(col.key)"
                class="checkbox-input">
              <span class="checkbox-text">{{ getColumnDisplayName(col.key) }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="search-box">
      <input type="text" [(ngModel)]="searchTerm" placeholder="Search..." (input)="onSearch()">
      <button class="search-btn" (click)="onSearch()">Search</button>
      <button class="clear-btn" (click)="clearFilters()">Clear</button>
    </div>
  </div>

  <div class="table-container">
    <table class="gin-transfers-table">
      <thead>
        <tr>
          <th *ngIf="columnVisibility.date" (click)="sortData('date')">
            Date <span class="sort-icon" *ngIf="currentSortColumn === 'date'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.referenceNo" (click)="sortData('referenceNo')">
            Reference No <span class="sort-icon" *ngIf="currentSortColumn === 'referenceNo'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.locationFrom" (click)="sortData('locationFrom')">
            Location (From) <span class="sort-icon" *ngIf="currentSortColumn === 'locationFrom'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.locationTo" (click)="sortData('locationTo')">
            Location (To) <span class="sort-icon" *ngIf="currentSortColumn === 'locationTo'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.products">Products</th>
          <th *ngIf="columnVisibility.status" (click)="sortData('status')">
            Status <span class="sort-icon" *ngIf="currentSortColumn === 'status'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.shippingCharges" (click)="sortData('shippingCharges')">
            Shipping <span class="sort-icon" *ngIf="currentSortColumn === 'shippingCharges'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.totalAmount" (click)="sortData('totalAmount')">
            Total Amount <span class="sort-icon" *ngIf="currentSortColumn === 'totalAmount'"><i class="fa" [ngClass]="isAscending ? 'fa-sort-asc' : 'fa-sort-desc'"></i></span>
          </th>
          <th *ngIf="columnVisibility.additionalNotes">Notes</th>
          <th *ngIf="columnVisibility.action" class="action-column">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let transfer of getCurrentPageItems()">
          <td *ngIf="columnVisibility.date">{{ transfer.date | date:'dd-MM-yyyy HH:mm' }}</td>
          <td *ngIf="columnVisibility.referenceNo">{{ transfer.referenceNo }}</td>
          <td *ngIf="columnVisibility.locationFrom">{{ getLocationName(transfer.locationFrom) }}</td>
          <td *ngIf="columnVisibility.locationTo">
            <div class="destination-locations">
                <ng-container *ngIf="transfer.transfers && transfer.transfers.length > 0; else legacyLocationTo">
                    <div *ngFor="let locationTransfer of transfer.transfers" class="location-item">
                        {{ locationTransfer.locationName || getLocationName(locationTransfer.locationId) }}
                    </div>
                </ng-container>
                <ng-template #legacyLocationTo>
                    {{ getLocationName(transfer.locationTo) }}
                </ng-template>
            </div>
          </td>
          <td *ngIf="columnVisibility.products">
            <div class="product-list">
              <div *ngFor="let product of getAllProducts(transfer)" class="product-item">
                {{ product.productName }} ({{ product.quantity }} {{ product.unit }})
              </div>
            </div>
          </td>
          <td *ngIf="columnVisibility.status">
            <span class="status-badge" [ngClass]="transfer.status.toLowerCase()" (click)="openStatusModal(transfer)">
              {{ transfer.status }}
            </span>
          </td>
          <td *ngIf="columnVisibility.shippingCharges">{{ transfer.shippingCharges | currency:'INR' }}</td>
          <td *ngIf="columnVisibility.totalAmount">{{ transfer.totalAmount | currency:'INR' }}</td>
          <td *ngIf="columnVisibility.additionalNotes">
            <span [title]="transfer.additionalNotes" class="notes-cell">
              {{ (transfer.additionalNotes && transfer.additionalNotes.length > 30) ? (transfer.additionalNotes | slice:0:30) + '...' : transfer.additionalNotes }}
            </span>
          </td>
          <td *ngIf="columnVisibility.action" class="action-column">
            <div class="action-buttons">
              <button class="view-btn" (click)="viewGinTransfer(transfer)" title="View">
                <i class="fa fa-eye"></i>
              </button>
              <button class="delete-btn" (click)="deleteGinTransfer(transfer.id!)" title="Delete">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="filteredGinTransfers.length === 0">
          <td [attr.colspan]="getVisibleColumnsCount()" class="no-data">No GIN transfers found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
      {{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} entries
    </div>
    <div class="pagination-controls">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">Previous</button>
      
      <button class="page-btn" [ngClass]="{'active': currentPage === 1}" (click)="goToPage(1)">1</button>
      
      <ng-container *ngIf="currentPage > 3">
        <span class="ellipsis">...</span>
      </ng-container>
      
      <ng-container *ngFor="let page of [currentPage - 1, currentPage, currentPage + 1]">
        <button *ngIf="page > 1 && page < getTotalPages()" 
                class="page-btn" 
                [ngClass]="{'active': currentPage === page}" 
                (click)="goToPage(page)">
          {{ page }}
        </button>
      </ng-container>
      
      <ng-container *ngIf="currentPage < getTotalPages() - 2">
        <span class="ellipsis">...</span>
      </ng-container>
      
      <button *ngIf="getTotalPages() > 1" 
              class="page-btn" 
              [ngClass]="{'active': currentPage === getTotalPages()}" 
              (click)="goToPage(getTotalPages())">
        {{ getTotalPages() }}
      </button>
      
      <button class="page-btn" [disabled]="currentPage === getTotalPages()" (click)="goToPage(currentPage + 1)">Next</button>
    </div>
  </div>

  <!-- Status Update Modal -->
  <div class="status-update-modal" *ngIf="showStatusModal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Update Status</h4>
        <button class="close-btn" (click)="closeStatusModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p>Reference No: <strong>{{ selectedTransfer?.referenceNo }}</strong></p>
        
        <div class="form-group">
          <label for="status">Status:</label>
          <select id="status" [(ngModel)]="selectedStatus" class="form-control">
            <option value="Draft">Draft</option>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeStatusModal()">Cancel</button>
        <button class="save-btn" (click)="updateStatus()">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop" *ngIf="showStatusModal" (click)="closeStatusModal()"></div>

  <!-- Dropdown backdrop to close when clicking outside -->
  <div class="dropdown-backdrop" *ngIf="showColumnVisibilityDropdown" (click)="closeColumnVisibilityDropdown()"></div>
</div>