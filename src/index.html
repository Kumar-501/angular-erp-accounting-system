<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Irastellar</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- For PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Script to handle page refresh 404 issues -->
  <script>
    // Store the current path in sessionStorage when navigating
    (function() {
      // Save the current path when the page is about to unload (navigation)
      window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('lastPath', window.location.pathname + window.location.search + window.location.hash);
      });
      
      // Check if we're coming back from a 404
      if (sessionStorage.getItem('was404') === 'true') {
        // Clear the flag
        sessionStorage.removeItem('was404');
        
        // Retrieve the last path and navigate to it
        var lastPath = sessionStorage.getItem('lastPath');
        if (lastPath && lastPath !== '/' && lastPath !== '/index.html') {
          // Set a flag to prevent infinite loops
          sessionStorage.setItem('redirecting', 'true');
          window.location.replace(lastPath);
        }
      }
      
      // Handle 404 errors
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        handlePotential404();
      } else {
        document.addEventListener('DOMContentLoaded', handlePotential404);
      }
      
      function handlePotential404() {
        // If we are on the 404 page (this requires your server to actually serve a 404.html file)
        if (document.title.includes('404') || window.location.pathname.includes('404')) {
          // Set a flag that we were on a 404
          sessionStorage.setItem('was404', 'true');
          // Navigate back to root
          if (sessionStorage.getItem('redirecting') !== 'true') {
            sessionStorage.removeItem('redirecting');
            window.location.replace('/');
          }
        }
      }
    })();
  </script>
</head>
<body class="mat-typography">
  <app-root></app-root>
  
  <!-- Fallback script in case app doesn't load properly -->
  <script>
    // This helps recover from 404 errors when refreshing the page
    window.addEventListener('load', function() {
      // Check if Angular app has loaded by looking for Angular-generated elements
      setTimeout(function() {
        var appRoot = document.querySelector('app-root');
        if (appRoot && appRoot.children.length === 0) {
          console.log('Angular app failed to initialize properly, attempting recovery...');
          
          // Store current URL to recover after redirect
          sessionStorage.setItem('recoveryUrl', window.location.pathname + window.location.search + window.location.hash);
          
          // Redirect to base URL to ensure proper loading
          if (window.location.pathname !== '/' && window.location.pathname !== '/index.html') {
            window.location.href = '/';
          }
        }
        
        // Check if we are coming from a recovery redirect
        var recoveryUrl = sessionStorage.getItem('recoveryUrl');
        if (recoveryUrl && window.location.pathname === '/') {
          console.log('Recovering from redirect, navigating to:', recoveryUrl);
          // Clear recovery URL
          sessionStorage.removeItem('recoveryUrl');
          // We need to wait for Angular to initialize
          setTimeout(function() {
            // Use Angular router for navigation (works if Angular is available)
            var navEvent = new CustomEvent('angularNavigation', { detail: { url: recoveryUrl } });
            window.dispatchEvent(navEvent);
            
            // Fallback: direct navigation if event handler isn't set up
            setTimeout(function() {
              if (window.location.pathname === '/') {
                window.history.pushState(null, '', recoveryUrl);
                // Try to trigger Angular router
                var popStateEvent = new PopStateEvent('popstate', { state: null });
                window.dispatchEvent(popStateEvent);
              }
            }, 300);
          }, 500);
        }
      }, 1000);
    });
  </script>
</body>
</html>
